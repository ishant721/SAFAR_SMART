{% extends 'base.html' %}
{% load static %}

{% block title %}Trip Details - {{ trip.destination }} - SAFAR_SMART{% endblock %}

{% block content %}
<!-- Trip Header -->
<section class="trip-detail-header fade-in-up">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3">{{ trip.destination }}</h1>
            <p class="lead mb-4">{{ trip.month }} ‚Ä¢ {{ trip.duration }} days ‚Ä¢ {{ trip.holiday_type }}</p>
            {% if trip.comments %}
            <p class="mb-0"><i class="bi bi-chat-quote"></i> "{{ trip.comments }}"</p>
            {% endif %}
        </div>
        <div class="col-lg-4 text-lg-end">
            <a href="{% url 'planner:dashboard' %}" class="btn btn-light btn-lg">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</section>

<div class="row g-4">
    <!-- Trip Navigation Sidebar -->
    <div class="col-lg-3">
        <div class="sidebar-modern">
            <h3 class="sidebar-title">
                <i class="bi bi-compass"></i>
                Trip Menu
            </h3>
            <ul class="list-unstyled">
                <li><a href="#itinerary" class="sidebar-link active" data-target="itinerary"><i class="bi bi-map me-2"></i>Itinerary</a></li>
                <li><a href="#activities" class="sidebar-link" data-target="activities"><i class="bi bi-calendar-event me-2"></i>Activities</a></li>
                <li><a href="#weather" class="sidebar-link" data-target="weather"><i class="bi bi-cloud-sun me-2"></i>Weather</a></li>
                <li><a href="#packing" class="sidebar-link" data-target="packing"><i class="bi bi-bag me-2"></i>Packing List</a></li>
                <li><a href="#food" class="sidebar-link" data-target="food"><i class="bi bi-cup-hot me-2"></i>Food & Culture</a></li>
                <li><a href="#accommodation" class="sidebar-link" data-target="accommodation"><i class="bi bi-house me-2"></i>Accommodation</a></li>
                <li><a href="#expenses" class="sidebar-link" data-target="expenses"><i class="bi bi-currency-dollar me-2"></i>Expenses</a></li>
                <li><a href="#complete-plan" class="sidebar-link" data-target="complete-plan"><i class="bi bi-journal-check me-2"></i>Complete Plan</a></li>
                <li><a href="#links" class="sidebar-link" data-target="links"><i class="bi bi-link-45deg me-2"></i>Useful Links</a></li>
                <li><a href="#chat" class="sidebar-link" data-target="chat"><i class="bi bi-robot me-2"></i>AI Assistant</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 fade-in-up-delay-2">
        <div id="itinerary" class="content-section tab-content active">
            <h2 class="section-title"><i class="bi bi-map"></i> Your Itinerary</h2>
            {% if trip.itinerary %}
                <div class="rendered-content">{{ trip.itinerary|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-map"></i>
                    <h5>No itinerary generated yet.</h5>
                    <p>Click the "Complete Plan" button to generate a full itinerary.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('complete_trip_plan', {{ trip.id }})">Generate Itinerary</button>
                </div>
            {% endif %}
        </div>

        <div id="activities" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-calendar-event"></i> Activity Suggestions</h2>
            {% if trip.activity_suggestions %}
                <div class="row g-3">
                    {% for activity in trip.activity_suggestions %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ activity.name }}</h6>
                                <p class="text-muted small mb-3">{{ activity.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if activity.link %}<a href="{{ activity.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if activity.image_url %}<a href="{{ activity.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if activity.video_url %}<a href="{{ activity.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-event"></i>
                    <h5>No activity suggestions yet.</h5>
                    <p>Click the button to get activity recommendations.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('recommend_activities', {{ trip.id }})">Get Activities</button>
                </div>
            {% endif %}
        </div>

        <div id="weather" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cloud-sun"></i> Weather Forecast</h2>
            {% if trip.weather_forecast %}
                <div class="rendered-content">{{ trip.weather_forecast|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-cloud-sun"></i>
                    <h5>No weather forecast available.</h5>
                    <p>Click the button to get the latest weather forecast.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('weather_forecaster', {{ trip.id }})">Get Weather</button>
                </div>
            {% endif %}
        </div>

        <div id="packing" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-bag"></i> Packing List</h2>
            {% if trip.packing_list %}
                <div class="rendered-content">{{ trip.packing_list|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-bag"></i>
                    <h5>No packing list generated yet.</h5>
                    <p>Click the button to get a personalized packing list.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('packing_list_generator', {{ trip.id }})">Get Packing List</button>
                </div>
            {% endif %}
        </div>

        <div id="food" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cup-hot"></i> Food & Culture</h2>
            {% if trip.food_culture_info %}
                {% if trip.food_culture_info.food_options %}
                <h5 class="fw-bold mb-3">üçΩÔ∏è Food Options</h5>
                <div class="row g-3 mb-4">
                    {% for food_item in trip.food_culture_info.food_options %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ food_item.name }}</h6>
                                <p class="text-muted small mb-3">{{ food_item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if food_item.link %}<a href="{{ food_item.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if food_item.image_url %}<a href="{{ food_item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if food_item.video_url %}<a href="{{ food_item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if trip.food_culture_info.cultural_info %}
                <h5 class="fw-bold mb-3">üèõÔ∏è Cultural Information</h5>
                <div class="rendered-content">{{ trip.food_culture_info.cultural_info|safe }}</div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-cup-hot"></i>
                    <h5>No food and culture information yet.</h5>
                    <p>Click the button to get recommendations.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('food_culture_recommender', {{ trip.id }})">Get Info</button>
                </div>
            {% endif %}
        </div>

        <div id="accommodation" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-house"></i> Accommodation</h2>
            {% if trip.accommodation_info %}
                <div class="row g-3">
                    {% for item in trip.accommodation_info %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-0">{{ item.name }}</h6>
                                    {% if item.rating %}<span class="badge bg-warning">‚≠ê {{ item.rating }}</span>{% endif %}
                                </div>
                                <p class="text-muted small mb-3">{{ item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="{{ item.link }}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-house"></i> Book Now</a>
                                    {% if item.image_url %}<a href="{{ item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photos</a>{% endif %}
                                    {% if item.video_url %}<a href="{{ item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Tour</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-house"></i>
                    <h5>No accommodation recommendations yet.</h5>
                    <p>Click the button to get suggestions.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('accommodation_recommender', {{ trip.id }})">Get Stays</button>
                </div>
            {% endif %}
        </div>

        <div id="expenses" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-currency-dollar"></i> Expense Breakdown</h2>
            {% if trip.expense_breakdown %}
                <div class="rendered-content">{{ trip.expense_breakdown|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-currency-dollar"></i>
                    <h5>No expense breakdown available.</h5>
                    <p>Click the button to generate a cost analysis.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('expense_breakdown', {{ trip.id }})">Get Expenses</button>
                </div>
            {% endif %}
        </div>

        <div id="complete-plan" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-journal-check"></i> Complete Trip Plan</h2>
            {% if trip.complete_trip_plan %}
                <div class="rendered-content">{{ trip.complete_trip_plan|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-journal-check"></i>
                    <h5>No complete trip plan generated yet.</h5>
                    <p>Click the button to get a comprehensive overview.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('complete_trip_plan', {{ trip.id }})">Get Complete Plan</button>
                </div>
            {% endif %}
        </div>

        <div id="links" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-link-45deg"></i> Useful Links</h2>
            {% if trip.useful_links %}
                <div class="row g-3">
                    {% for link in trip.useful_links %}
                    <div class="col-md-6">
                        <a href="{{ link.link }}" target="_blank" class="card-modern text-decoration-none h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold text-primary mb-2">{{ link.title }}</h6>
                                <small class="text-muted">{{ link.link|truncatechars:50 }}</small>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-link-45deg"></i>
                    <h5>No useful links available yet.</h5>
                    <p>Click the button to fetch useful links.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('fetch_useful_links', {{ trip.id }})">Get Links</button>
                </div>
            {% endif %}
        </div>

        <div id="chat" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-robot"></i> AI Travel Assistant</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    {% for message in trip.chatmessage_set.all %}
                    <div class="chat-message chat-message-user">
                        <div class="chat-bubble chat-bubble-user">{{ message.question }}</div>
                        <img src="https://placehold.co/40x40/3b82f6/FFFFFF/png" alt="User Avatar" class="chat-avatar">
                    </div>
                    <div class="chat-message chat-message-ai">
                        <img src="{% static 'images/logo.png' %}" alt="AI Avatar" class="chat-avatar">
                        <div class="chat-bubble chat-bubble-ai">
                            <div class="rendered-content">{{ message.response|safe }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-chat-dots display-4 mb-3"></i>
                        <p>No messages yet. Start a conversation!</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="chat-input-container">
                    <form id="chatForm" action="{% url 'chat_with_agent' trip.id %}" method="post">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="user_question" class="form-control" placeholder="Ask about your trip..." required>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const logoUrl = "{% static 'images/logo.png' %}";

document.addEventListener('DOMContentLoaded', function() {
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const tabContents = document.querySelectorAll('.tab-content');

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Deactivate all links and tabs
            sidebarLinks.forEach(l => l.classList.remove('active'));
            tabContents.forEach(t => t.style.display = 'none');

            // Activate the clicked link and tab
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'block';
        });
    });
});

function processTrip(agentName, tripId) {
    // This function might need to be adapted if you want to show a loading state
    // inside the tab content instead of a full-page overlay.
    showLoading(`Generating ${agentName.replace('_', ' ')}...`);
    
    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `agent_name=${agentName}&user_question=Generate ${agentName.replace('_', ' ')}`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification('Information generated successfully!', 'success');
            if (data.warning) {
                showNotification('Warning: ' + data.warning, 'warning');
            }
            setTimeout(() => location.reload(), 1000); // Reload to see the new content
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('An error occurred while processing your request.', 'error');
    });
}

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const question = formData.get('user_question');
    
    if (!question.trim()) return;
    
    addChatMessage(question, 'user');
    this.querySelector('input[name="user_question"]').value = '';
    addTypingIndicator();
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.status === 'success') {
            addChatMessage(data.chat_response, 'ai');
        } else {
            addChatMessage('Sorry, I encountered an error.', 'ai');
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        addChatMessage('Sorry, I encountered an error.', 'ai');
        showNotification('An error occurred while sending your message.', 'error');
    });
});

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message chat-message-${sender}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${sender}`;
    bubble.innerHTML = message;

    const avatar = document.createElement('img');
    avatar.className = 'chat-avatar';
    if (sender === 'user') {
        avatar.src = 'https://placehold.co/40x40/3b82f6/FFFFFF/png';
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
    } else {
        avatar.src = logoUrl;
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message chat-message-ai';
    typingDiv.id = 'typingIndicator';
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-ai';
    bubble.innerHTML = '<i class="bi bi-three-dots"></i> AI is typing...';
    
    typingDiv.appendChild(bubble);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}
</script>
{% endblock %}