{% extends 'base.html' %}
{% load static %}

{% block title %}Trip Details - {{ trip.destination }} - SAFAR_SMART{% endblock %}

{% block content %}
<!-- Trip Header -->
<section class="trip-detail-header fade-in-up">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3">{{ trip.destination }}</h1>
            <p class="lead mb-4">{{ trip.month }} ‚Ä¢ {{ trip.duration }} days ‚Ä¢ {{ trip.holiday_type }}</p>
            {% if trip.comments %}
            <p class="mb-0"><i class="bi bi-chat-quote"></i> "{{ trip.comments }}"</p>
            {% endif %}
        </div>
        <div class="col-lg-4 text-lg-end">
            <a href="{% url 'dashboard' %}" class="btn btn-light btn-lg">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</section>

<div class="row g-4">
    <!-- Trip Navigation Sidebar -->
    <div class="col-lg-3">
        <div class="sidebar-modern">
            <h3 class="sidebar-title">
                <i class="bi bi-compass"></i>
                Trip Menu
            </h3>
            <ul class="list-unstyled">
                <li><a href="#itinerary" class="sidebar-link active" data-target="itinerary"><i class="bi bi-map me-2"></i>Itinerary</a></li>
                <li><a href="#journey-progress" class="sidebar-link" data-target="journey-progress"><i class="bi bi-check-circle me-2"></i>Journey Progress</a></li>
                <li><a href="#activities" class="sidebar-link" data-target="activities"><i class="bi bi-calendar-event me-2"></i>Activities</a></li>
                <li><a href="#weather" class="sidebar-link" data-target="weather"><i class="bi bi-cloud-sun me-2"></i>Weather</a></li>
                <li><a href="#packing" class="sidebar-link" data-target="packing"><i class="bi bi-bag me-2"></i>Packing List</a></li>
                <li><a href="#food" class="sidebar-link" data-target="food"><i class="bi bi-cup-hot me-2"></i>Food & Culture</a></li>
                <li><a href="#accommodation" class="sidebar-link" data-target="accommodation"><i class="bi bi-house me-2"></i>Accommodation</a></li>
                <li><a href="#expenses" class="sidebar-link" data-target="expenses"><i class="bi bi-currency-dollar me-2"></i>Expenses</a></li>
                <li><a href="#complete-plan" class="sidebar-link" data-target="complete-plan"><i class="bi bi-journal-check me-2"></i>Complete Plan</a></li>
                <li><a href="#links" class="sidebar-link" data-target="links"><i class="bi bi-link-45deg me-2"></i>Useful Links</a></li>
                <li><a href="#chat" class="sidebar-link" data-target="chat"><i class="bi bi-robot me-2"></i>AI Assistant</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 fade-in-up-delay-2">
        <div id="itinerary" class="content-section tab-content active">
            <h2 class="section-title"><i class="bi bi-map"></i> Your Complete Itinerary</h2>
            {% if trip.itinerary %}
                <div class="rendered-content">{{ trip.itinerary|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-magic-wand"></i>
                    <h5>Ready to create your complete trip?</h5>
                    <p>Generate everything at once: itinerary, activities, weather, accommodation, expenses, and more!</p>
                    <button class="btn btn-primary-modern btn-lg" onclick="generateCompleteTrip({{ trip.id }})">
                        ‚ú® Generate Complete Trip Plan
                    </button>
                    <p class="text-muted mt-2">This will create your full trip plan with all details automatically</p>
                </div>
            {% endif %}
        </div>

        <div id="journey-progress" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-check-circle"></i> Journey Progress</h2>
            
            <!-- Trip Progress Overview -->
            <div class="progress-overview mb-4 p-3" style="background: linear-gradient(135deg, #8B4513, #A0522D); color: white; border-radius: 10px;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">üìä Trip Progress</h5>
                        <p class="mb-0" id="progressSummary">0 of 0 checkpoints completed (0.0%)</p>
                    </div>
                    <div class="text-end">
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-light text-dark" id="totalBadge">0 Total Stops</span>
                            <span class="badge bg-success" id="completedBadge">0 Completed</span>
                            <span class="badge bg-warning" id="remainingBadge">0 Remaining</span>
                        </div>
                        <div class="progress" style="height: 8px; background: rgba(255,255,255,0.3);">
                            <div class="progress-bar bg-success" id="mainProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-success" id="startJourneyBtn" onclick="startJourney()">
                    ‚ñ∂Ô∏è Start Journey
                </button>
                <button class="btn btn-warning" onclick="switchToSection('chat')">
                    ü§ñ Travel Assistant
                </button>
                <a href="{% url 'download_trip_pdf' trip.id %}" class="btn btn-primary">
                    üìÑ Download PDF
                </a>
                <button class="btn btn-secondary" onclick="switchToSection('itinerary')">
                    ‚Üê Back
                </button>
            </div>

            <!-- Journey Timeline -->
            <div id="journeyTimeline">
                <!-- Days and checkpoints will be dynamically loaded here -->
                <div id="timelineContainer"></div>
                
                <div class="text-center mt-4" id="loadJourneySection">
                    {% if trip.complete_trip_plan %}
                        <button class="btn btn-primary-modern" onclick="loadJourneyCheckpoints()">
                            üó∫Ô∏è Load Journey Checkpoints
                        </button>
                    {% else %}
                        <div class="empty-state">
                            <i class="bi bi-map"></i>
                            <h5>No trip plan available</h5>
                            <p>Generate your complete trip plan first to start tracking your journey!</p>
                            <button class="btn btn-primary-modern" onclick="generateCompleteTrip({{ trip.id }})">
                                ‚ú® Generate Complete Trip Plan
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="activities" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-calendar-event"></i> Activity Suggestions</h2>
            {% if trip.activity_suggestions %}
                <div class="row g-3">
                    {% for activity in trip.activity_suggestions %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ activity.name }}</h6>
                                <p class="text-muted small mb-3">{{ activity.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if activity.link %}<a href="{{ activity.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if activity.image_url %}<a href="{{ activity.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if activity.video_url %}<a href="{{ activity.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-event"></i>
                    <h5>No activity suggestions yet.</h5>
                    <p>Click the button to get activity recommendations.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('recommend_activities', {{ trip.id }})">Get Activities</button>
                </div>
            {% endif %}
        </div>

        <div id="weather" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cloud-sun"></i> Weather Forecast</h2>
            {% if trip.weather_forecast %}
                <div class="rendered-content">{{ trip.weather_forecast|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-cloud-sun"></i>
                    <h5>No weather forecast available.</h5>
                    <p>Click the button to get the latest weather forecast.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('weather_forecaster', {{ trip.id }})">Get Weather</button>
                </div>
            {% endif %}
        </div>

        <div id="packing" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-bag"></i> Packing List</h2>
            {% if trip.packing_list %}
                <div class="rendered-content">{{ trip.packing_list|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-bag"></i>
                    <h5>No packing list generated yet.</h5>
                    <p>Click the button to get a personalized packing list.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('packing_list_generator', {{ trip.id }})">Get Packing List</button>
                </div>
            {% endif %}
        </div>

        <div id="food" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cup-hot"></i> Food & Culture</h2>
            {% if trip.food_culture_info %}
                {% if trip.food_culture_info.food_options %}
                <h5 class="fw-bold mb-3">üçΩÔ∏è Food Options</h5>
                <div class="row g-3 mb-4">
                    {% for food_item in trip.food_culture_info.food_options %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ food_item.name }}</h6>
                                <p class="text-muted small mb-3">{{ food_item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if food_item.link %}<a href="{{ food_item.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if food_item.image_url %}<a href="{{ food_item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if food_item.video_url %}<a href="{{ food_item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if trip.food_culture_info.cultural_info %}
                <h5 class="fw-bold mb-3">üèõÔ∏è Cultural Information</h5>
                <div class="rendered-content">{{ trip.food_culture_info.cultural_info|safe }}</div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-cup-hot"></i>
                    <h5>No food and culture information yet.</h5>
                    <p>Click the button to get recommendations.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('food_culture_recommender', {{ trip.id }})">Get Info</button>
                </div>
            {% endif %}
        </div>

        <div id="accommodation" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-house"></i> Accommodation</h2>
            {% if trip.accommodation_info %}
                <div class="row g-3">
                    {% for item in trip.accommodation_info %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-0">{{ item.name }}</h6>
                                    {% if item.rating %}<span class="badge bg-warning">‚≠ê {{ item.rating }}</span>{% endif %}
                                </div>
                                <p class="text-muted small mb-3">{{ item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="{{ item.link }}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-house"></i> Book Now</a>
                                    {% if item.image_url %}<a href="{{ item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photos</a>{% endif %}
                                    {% if item.video_url %}<a href="{{ item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Tour</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-house"></i>
                    <h5>No accommodation recommendations yet.</h5>
                    <p>Click the button to get suggestions.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('accommodation_recommender', {{ trip.id }})">Get Stays</button>
                </div>
            {% endif %}
        </div>

        <div id="expenses" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-currency-dollar"></i> Expense Breakdown</h2>
            {% if trip.expense_breakdown %}
                <div class="rendered-content">{{ trip.expense_breakdown|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-currency-dollar"></i>
                    <h5>No expense breakdown available.</h5>
                    <p>Click the button to generate a cost analysis.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('expense_breakdown', {{ trip.id }})">Get Expenses</button>
                </div>
            {% endif %}
        </div>

        <div id="complete-plan" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-journal-check"></i> Complete Trip Plan</h2>
            {% if trip.complete_trip_plan %}
                <div class="rendered-content">{{ trip.complete_trip_plan|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-journal-check"></i>
                    <h5>Generate your trip plan first</h5>
                    <p>Your complete trip plan will appear here automatically after generating the complete trip.</p>
                    <button class="btn btn-primary-modern" onclick="generateCompleteTrip({{ trip.id }})">
                        ‚ú® Generate Complete Trip Plan
                    </button>
                </div>
            {% endif %}
        </div>

        <div id="links" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-link-45deg"></i> Useful Links</h2>
            {% if trip.useful_links %}
                <div class="row g-3">
                    {% for link in trip.useful_links %}
                    <div class="col-md-6">
                        <a href="{{ link.link }}" target="_blank" class="card-modern text-decoration-none h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold text-primary mb-2">{{ link.title }}</h6>
                                <small class="text-muted">{{ link.link|truncatechars:50 }}</small>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-link-45deg"></i>
                    <h5>No useful links available yet.</h5>
                    <p>Click the button to fetch useful links.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('fetch_useful_links', {{ trip.id }})">Get Links</button>
                </div>
            {% endif %}
        </div>

        <div id="chat" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-robot"></i> AI Travel Assistant</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    {% for message in trip.chatmessage_set.all %}
                    <div class="chat-message chat-message-user">
                        <div class="chat-bubble chat-bubble-user">{{ message.question }}</div>
                        <img src="https://placehold.co/40x40/3b82f6/FFFFFF/png" alt="User Avatar" class="chat-avatar">
                    </div>
                    <div class="chat-message chat-message-ai">
                        <img src="{% static 'images/logo.png' %}" alt="AI Avatar" class="chat-avatar">
                        <div class="chat-bubble chat-bubble-ai">
                            <div class="rendered-content">{{ message.response|safe }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-chat-dots display-4 mb-3"></i>
                        <p>No messages yet. Start a conversation!</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="chat-input-container">
                    <form id="chatForm" action="{% url 'chat_with_agent' trip.id %}" method="post">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="user_question" class="form-control" placeholder="Ask about your trip..." required>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.journey-day {
    background: linear-gradient(135deg, #8B4513, #A0522D);
    color: white;
    padding: 1rem 1.5rem;
    margin: 1rem 0;
    border-radius: 10px;
    position: relative;
}

.day-progress-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.day-progress-fill {
    height: 100%;
    background: #28a745;
    border-radius: 3px;
    transition: width 0.3s ease;
}

.checkpoint-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    margin: 1rem 0;
    padding: 1.5rem;
    position: relative;
    transition: all 0.3s ease;
    border-left: 4px solid #8B4513;
}

.checkpoint-item.completed {
    background: #d4edda;
    border-color: #28a745;
    border-left-color: #28a745;
}

.checkpoint-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.checkpoint-time {
    display: inline-flex;
    align-items: center;
    background: #8B4513;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.checkpoint-location {
    font-size: 1.1rem;
    font-weight: 700;
    color: #8B4513;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkpoint-description {
    color: #6c757d;
    margin-bottom: 1rem;
    line-height: 1.6;
}

.checkpoint-tip {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.experience-notes {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    width: 100%;
    min-height: 80px;
    margin-bottom: 1rem;
    resize: vertical;
}

.checkpoint-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.complete-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.complete-btn:hover {
    background: #218838;
    transform: translateY(-1px);
}

.complete-btn.completed {
    background: #6c757d;
    cursor: default;
}

.timeline-connector {
    position: absolute;
    left: 2rem;
    top: 0;
    bottom: -1rem;
    width: 2px;
    background: #8B4513;
    opacity: 0.3;
}

.timeline-connector.last {
    display: none;
}

.journey-started {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const logoUrl = "{% static 'images/logo.png' %}";
let journeyCheckpoints = [];
let completedCheckpoints = new Set();
let journeyStarted = false;

document.addEventListener('DOMContentLoaded', function() {
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const tabContents = document.querySelectorAll('.tab-content');

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Deactivate all links and tabs
            sidebarLinks.forEach(l => l.classList.remove('active'));
            tabContents.forEach(t => t.style.display = 'none');

            // Activate the clicked link and tab
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'block';
        });
    });

    // Load saved progress
    loadSavedProgress();
});

// Journey Progress Functions
function loadJourneyCheckpoints() {
    const tripPlan = `{{ trip.complete_trip_plan|escapejs }}`;
    const itinerary = `{{ trip.itinerary|escapejs }}`;
    
    if (!tripPlan && !itinerary) {
        showNotification('No trip plan available to parse checkpoints.', 'warning');
        return;
    }
    
    // Parse checkpoints from the trip plan
    journeyCheckpoints = parseCheckpointsFromText(tripPlan || itinerary);
    
    if (journeyCheckpoints.length === 0) {
        showNotification('No checkpoints found in the trip plan.', 'warning');
        return;
    }
    
    // Apply any saved notes to the checkpoints
    applySavedNotesToCheckpoints();
    
    // Render the timeline
    renderJourneyTimeline();
    updateProgressDisplay();
    
    // Hide the load button
    document.getElementById('loadJourneySection').style.display = 'none';
    
    showNotification(`Loaded ${journeyCheckpoints.length} checkpoints from your trip plan!`, 'success');
}

function parseCheckpointsFromText(text) {
    const checkpoints = [];
    
    // Strip HTML tags and decode HTML entities for proper text parsing
    const cleanText = text.replace(/<[^>]*>/g, '')
                          .replace(/&nbsp;/g, ' ')
                          .replace(/&amp;/g, '&')
                          .replace(/&lt;/g, '<')
                          .replace(/&gt;/g, '>')
                          .replace(/&quot;/g, '"')
                          .replace(/&#x27;/g, "'")
                          .replace(/\r\n/g, '\n')
                          .replace(/\r/g, '\n');
    
    const lines = cleanText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    let currentDay = 1;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Detect day headers
        const dayMatch = line.match(/Day\s*(\d+)/i);
        if (dayMatch) {
            currentDay = parseInt(dayMatch[1]);
            continue;
        }
        
        // Pattern matching for different checkpoint formats
        let checkpoint = null;
        
        // Pattern 1: Morning (Temple Darshan): Description
        const pattern1 = line.match(/^(\w+)\s*\(([^)]+)\):\s*(.+)/);
        if (pattern1) {
            checkpoint = createCheckpoint(
                checkpoints.length,
                currentDay,
                pattern1[1], // time (Morning, Afternoon, etc)
                pattern1[2], // location (Temple Darshan)
                pattern1[3], // description
                lines, i
            );
        }
        
        // Pattern 2: 09:00 - Activity
        const pattern2 = line.match(/^(\d{1,2}):(\d{2})\s*[-:]\s*(.+)/);
        if (pattern2) {
            const timeStr = `${pattern2[1]}:${pattern2[2]}`;
            const activity = pattern2[3];
            checkpoint = createCheckpoint(
                checkpoints.length,
                currentDay,
                timeStr,
                activity.split('.')[0].trim(),
                activity,
                lines, i
            );
        }
        
        // Pattern 3: ‚Ä¢ Morning (Temple Darshan): Description  
        const pattern3 = line.match(/^‚Ä¢\s*(\w+)\s*\(([^)]+)\):\s*(.+)/);
        if (pattern3) {
            checkpoint = createCheckpoint(
                checkpoints.length,
                currentDay,
                pattern3[1],
                pattern3[2],
                pattern3[3],
                lines, i
            );
        }
        
        // Pattern 4: Simple time format like "Morning: Activity"
        const pattern4 = line.match(/^(\w+):\s*(.+)/);
        if (pattern4 && !pattern1 && !pattern2 && !pattern3) {
            const timeStr = pattern4[1];
            const activity = pattern4[2];
            if (timeStr.match(/morning|afternoon|evening|night/i) || timeStr.match(/\d{1,2}:\d{2}/)) {
                checkpoint = createCheckpoint(
                    checkpoints.length,
                    currentDay,
                    timeStr,
                    activity.split('.')[0].trim(),
                    activity,
                    lines, i
                );
            }
        }
        
        if (checkpoint) {
            checkpoints.push(checkpoint);
        }
    }
    
    return checkpoints;
}

function createCheckpoint(id, day, time, location, description, lines, currentIndex) {
    // Clean up location and description
    location = location.replace(/^(visit|explore|go to|head to)\s*/i, '').trim();
    description = description.trim();
    
    // Look for tips in the next few lines
    let tip = '';
    for (let j = currentIndex + 1; j < Math.min(currentIndex + 3, lines.length); j++) {
        const nextLine = lines[j];
        if (nextLine && 
            !nextLine.match(/Day\s*\d+/i) && 
            !nextLine.match(/\d{1,2}:\d{2}/) &&
            !nextLine.match(/^(\w+):\s*(.+)/) &&
            (nextLine.toLowerCase().includes('tip') || 
             nextLine.toLowerCase().includes('avoid') ||
             nextLine.toLowerCase().includes('reach early') ||
             nextLine.toLowerCase().includes('take the') ||
             nextLine.toLowerCase().includes('recommend'))) {
            tip = nextLine;
            break;
        }
    }
    
    // Only create checkpoint if location is meaningful
    if (location.length > 2 && location.length < 100 && 
        !location.match(/^\d+$/) && 
        !location.match(/^(a|an|the|and|or|but|for|at|in|on|to)$/i)) {
        return {
            id: id,
            day: day,
            time: time,
            location: location,
            description: description,
            tip: tip,
            completed: false,
            notes: ''
        };
    }
    
    return null;
}

function renderJourneyTimeline() {
    const container = document.getElementById('timelineContainer');
    
    // Group checkpoints by day
    const dayGroups = {};
    journeyCheckpoints.forEach(checkpoint => {
        if (!dayGroups[checkpoint.day]) {
            dayGroups[checkpoint.day] = [];
        }
        dayGroups[checkpoint.day].push(checkpoint);
    });
    
    let timelineHTML = '';
    
    Object.keys(dayGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(day => {
        const dayCheckpoints = dayGroups[day];
        const completedCount = dayCheckpoints.filter(c => completedCheckpoints.has(c.id)).length;
        const totalCount = dayCheckpoints.length;
        const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        timelineHTML += `
            <div class="journey-day">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-1">üåç Day ${day}</h4>
                    <span class="badge bg-light text-dark">${completedCount}/${totalCount} completed</span>
                </div>
                <div class="day-progress-bar">
                    <div class="day-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
            </div>
        `;
        
        dayCheckpoints.forEach((checkpoint, index) => {
            const isCompleted = completedCheckpoints.has(checkpoint.id);
            const isLast = index === dayCheckpoints.length - 1;
            
            timelineHTML += `
                <div class="checkpoint-item ${isCompleted ? 'completed' : ''}" id="checkpoint-${checkpoint.id}">
                    <div class="checkpoint-time">
                        üïê ${checkpoint.time}
                    </div>
                    
                    <div class="checkpoint-location">
                        üìç ${checkpoint.location}
                    </div>
                    
                    <div class="checkpoint-description">
                        ${checkpoint.description}
                    </div>
                    
                    ${checkpoint.tip ? `
                        <div class="checkpoint-tip">
                            üí° ${checkpoint.tip}
                        </div>
                    ` : ''}
                    
                    <textarea 
                        class="experience-notes" 
                        placeholder="Add your experience notes..."
                        onchange="saveCheckpointNotes(${checkpoint.id}, this.value)"
                        ${isCompleted ? '' : 'style="display: none;"'}
                    >${checkpoint.notes}</textarea>
                    
                    <div class="checkpoint-actions">
                        <div></div>
                        <button 
                            class="complete-btn ${isCompleted ? 'completed' : ''}" 
                            onclick="toggleCheckpointCompletion(${checkpoint.id})"
                            ${isCompleted ? 'disabled' : ''}
                        >
                            ${isCompleted ? '‚úÖ Completed' : '‚úì Complete'}
                        </button>
                    </div>
                    
                    ${!isLast ? '<div class="timeline-connector"></div>' : ''}
                </div>
            `;
        });
    });
    
    container.innerHTML = timelineHTML;
}

function startJourney() {
    if (journeyCheckpoints.length === 0) {
        showNotification('Please load journey checkpoints first!', 'warning');
        return;
    }
    
    journeyStarted = true;
    saveProgressToLocalStorage();
    
    document.getElementById('startJourneyBtn').innerHTML = 'üéØ Journey Started';
    document.getElementById('startJourneyBtn').classList.add('journey-started');
    document.getElementById('startJourneyBtn').disabled = true;
    
    showNotification('üéâ Journey started! Begin exploring your checkpoints.', 'success');
}

function toggleCheckpointCompletion(checkpointId) {
    if (!journeyStarted) {
        showNotification('Please start your journey first!', 'warning');
        return;
    }
    
    const checkpoint = journeyCheckpoints.find(c => c.id === checkpointId);
    if (!checkpoint) return;
    
    completedCheckpoints.add(checkpointId);
    checkpoint.completed = true;
    
    const element = document.getElementById(`checkpoint-${checkpointId}`);
    element.classList.add('completed');
    
    const button = element.querySelector('.complete-btn');
    button.innerHTML = '‚úÖ Completed';
    button.classList.add('completed');
    button.disabled = true;
    
    const textarea = element.querySelector('.experience-notes');
    textarea.style.display = 'block';
    
    updateProgressDisplay();
    saveProgressToLocalStorage();
    
    showNotification(`‚úÖ Completed "${checkpoint.location}"!`, 'success');
}

function saveCheckpointNotes(checkpointId, notes) {
    const checkpoint = journeyCheckpoints.find(c => c.id === checkpointId);
    if (checkpoint) {
        checkpoint.notes = notes;
        saveProgressToLocalStorage();
        if (notes.trim()) {
            showNotification('Notes saved!', 'success');
        }
    }
}

function updateProgressDisplay() {
    const total = journeyCheckpoints.length;
    const completed = completedCheckpoints.size;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    const progressSummaryEl = document.getElementById('progressSummary');
    const totalBadgeEl = document.getElementById('totalBadge');
    const completedBadgeEl = document.getElementById('completedBadge');
    const remainingBadgeEl = document.getElementById('remainingBadge');
    const mainProgressBarEl = document.getElementById('mainProgressBar');
    
    if (progressSummaryEl) {
        progressSummaryEl.textContent = `${completed} of ${total} checkpoints completed (${percentage}%)`;
    }
    if (totalBadgeEl) {
        totalBadgeEl.textContent = `${total} Total Stops`;
    }
    if (completedBadgeEl) {
        completedBadgeEl.textContent = `${completed} Completed`;
    }
    if (remainingBadgeEl) {
        remainingBadgeEl.textContent = `${total - completed} Remaining`;
    }
    if (mainProgressBarEl) {
        mainProgressBarEl.style.width = `${percentage}%`;
    }
    
    // Re-render timeline to update day progress if we're in the journey section
    const currentSection = document.querySelector('.content-section[style*="block"]') || 
                          document.querySelector('.content-section.active');
    if (currentSection && currentSection.id === 'journey-progress' && journeyCheckpoints.length > 0) {
        renderJourneyTimeline();
    }
}

function saveProgressToLocalStorage() {
    const progressData = {
        tripId: {{ trip.id }},
        journeyStarted: journeyStarted,
        completedCheckpoints: Array.from(completedCheckpoints),
        checkpointNotes: journeyCheckpoints.reduce((acc, checkpoint) => {
            if (checkpoint.notes) {
                acc[checkpoint.id] = checkpoint.notes;
            }
            return acc;
        }, {}),
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('journeyProgress_{{ trip.id }}', JSON.stringify(progressData));
}

function loadSavedProgress() {
    const savedProgress = localStorage.getItem('journeyProgress_{{ trip.id }}');
    if (savedProgress) {
        try {
            const data = JSON.parse(savedProgress);
            journeyStarted = data.journeyStarted || false;
            completedCheckpoints = new Set(data.completedCheckpoints || []);
            
            const startJourneyBtn = document.getElementById('startJourneyBtn');
            if (journeyStarted && startJourneyBtn) {
                startJourneyBtn.innerHTML = 'üéØ Journey Started';
                startJourneyBtn.classList.add('journey-started');
                startJourneyBtn.disabled = true;
            }
            
            // Apply saved notes to checkpoints - will be applied after checkpoints are loaded
            window.savedCheckpointNotes = data.checkpointNotes || {};
            
            console.log('Loaded progress:', { journeyStarted, completedCount: completedCheckpoints.size });
        } catch (e) {
            console.error('Error loading saved progress:', e);
        }
    }
}

function applySavedNotesToCheckpoints() {
    if (window.savedCheckpointNotes && journeyCheckpoints.length > 0) {
        Object.keys(window.savedCheckpointNotes).forEach(checkpointId => {
            const checkpoint = journeyCheckpoints.find(c => c.id === parseInt(checkpointId));
            if (checkpoint) {
                checkpoint.notes = window.savedCheckpointNotes[checkpointId];
            }
        });
        delete window.savedCheckpointNotes; // Clean up
    }
}

function switchToSection(sectionId) {
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const tabContents = document.querySelectorAll('.tab-content');
    
    sidebarLinks.forEach(l => l.classList.remove('active'));
    tabContents.forEach(t => t.style.display = 'none');
    
    const targetLink = document.querySelector(`[data-target="${sectionId}"]`);
    const targetSection = document.getElementById(sectionId);
    
    if (targetLink) targetLink.classList.add('active');
    if (targetSection) targetSection.style.display = 'block';
}

function generateCompleteTrip(tripId) {
    showLoading('üéØ Generating your complete trip plan...\n\nThis includes:\n‚Ä¢ Detailed itinerary\n‚Ä¢ Activity suggestions\n‚Ä¢ Weather forecast\n‚Ä¢ Packing list\n‚Ä¢ Food & culture info\n‚Ä¢ Accommodation options\n‚Ä¢ Expense breakdown\n‚Ä¢ Comprehensive plan\n\nPlease wait, this may take a few moments...');
    
    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `agent_name=generate_complete_trip&user_question=Generate complete trip plan with all components`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification('üéâ Complete trip plan generated successfully! All sections have been populated.', 'success');
            
            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                data.warnings.forEach(warning => {
                    showNotification(`‚ö†Ô∏è ${warning}`, 'warning');
                });
            }
            
            // Auto-load journey checkpoints if we're on the journey progress section
            const journeySection = document.getElementById('journey-progress');
            if (journeySection && journeySection.style.display !== 'none') {
                setTimeout(() => {
                    loadJourneyCheckpoints();
                }, 1000);
            }
            
            // Reload page to show all generated content
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('An error occurred while generating your complete trip plan.', 'error');
    });
}

function processTrip(agentName, tripId) {
    showLoading(`Generating ${agentName.replace('_', ' ')}...`);
    
    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `agent_name=${agentName}&user_question=Generate ${agentName.replace('_', ' ')}`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification('Information generated successfully!', 'success');
            if (data.warning) {
                showNotification('Warning: ' + data.warning, 'warning');
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('An error occurred while processing your request.', 'error');
    });
}

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const question = formData.get('user_question');
    
    if (!question.trim()) return;
    
    addChatMessage(question, 'user');
    this.querySelector('input[name="user_question"]').value = '';
    addTypingIndicator();
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.status === 'success') {
            addChatMessage(data.chat_response, 'ai');
        } else {
            addChatMessage('Sorry, I encountered an error.', 'ai');
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        addChatMessage('Sorry, I encountered an error.', 'ai');
        showNotification('An error occurred while sending your message.', 'error');
    });
});

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message chat-message-${sender}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${sender}`;
    bubble.innerHTML = message;

    const avatar = document.createElement('img');
    avatar.className = 'chat-avatar';
    if (sender === 'user') {
        avatar.src = 'https://placehold.co/40x40/3b82f6/FFFFFF/png';
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
    } else {
        avatar.src = logoUrl;
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message chat-message-ai';
    typingDiv.id = 'typingIndicator';
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-ai';
    bubble.innerHTML = '<i class="bi bi-three-dots"></i> AI is typing...';
    
    typingDiv.appendChild(bubble);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}
</script>
{% endblock %}