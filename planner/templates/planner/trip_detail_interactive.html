{% extends 'base.html' %}
{% load static %}

{% block title %}Trip Details - {{ trip.destination }} - SAFAR_SMART{% endblock %}

{% block content %}
<!-- Trip Header -->
<section class="trip-detail-header fade-in-up">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3">{{ trip.destination }}</h1>
            <p class="lead mb-4">{{ trip.month }} ‚Ä¢ {{ trip.duration }} days ‚Ä¢ {{ trip.holiday_type }}</p>
            {% if trip.comments %}
            <p class="mb-0"><i class="bi bi-chat-quote"></i> "{{ trip.comments }}"</p>
            {% endif %}
        </div>
        <div class="col-lg-4 text-lg-end">
            
            <a href="{% url 'planner:dashboard' %}" class="btn btn-light btn-lg">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</section>

<div class="row g-4">
    <!-- Trip Navigation Sidebar -->
    <div class="col-lg-3">
        <div class="sidebar-modern">
            <h3 class="sidebar-title">
                <i class="bi bi-compass"></i>
                Trip Menu
            </h3>
            <ul class="list-unstyled">
                <li><a href="#itinerary" class="sidebar-link active" data-target="itinerary"><i class="bi bi-map me-2"></i>Itinerary</a></li>
                <li><a href="#journey-progress" class="sidebar-link" data-target="journey-progress"><i class="bi bi-check-circle me-2"></i>Journey Progress</a></li>
                <li><a href="#activities" class="sidebar-link" data-target="activities"><i class="bi bi-calendar-event me-2"></i>Activities</a></li>
                <li><a href="#weather" class="sidebar-link" data-target="weather"><i class="bi bi-cloud-sun me-2"></i>Weather</a></li>
                <li><a href="#packing" class="sidebar-link" data-target="packing"><i class="bi bi-bag me-2"></i>Packing List</a></li>
                <li><a href="#food" class="sidebar-link" data-target="food"><i class="bi bi-cup-hot me-2"></i>Food & Culture</a></li>
                <li><a href="#accommodation" class="sidebar-link" data-target="accommodation"><i class="bi bi-house me-2"></i>Accommodation</a></li>
                <li><a href="#expenses" class="sidebar-link" data-target="expenses"><i class="bi bi-currency-dollar me-2"></i>Expenses</a></li>
                
                <li><a href="#links" class="sidebar-link" data-target="links"><i class="bi bi-link-45deg me-2"></i>Useful Links</a></li>
                <li><a href="#chat" class="sidebar-link" data-target="chat"><i class="bi bi-robot me-2"></i>AI Assistant</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 fade-in-up-delay-2">
        <div id="itinerary" class="content-section tab-content active">
            <h2 class="section-title"><i class="bi bi-map"></i> Your Complete Itinerary</h2>
            {% if trip.itinerary %}
                <div class="rendered-content">{{ trip.itinerary|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-magic-wand"></i>
                    <h5>Ready to create your complete trip?</h5>
                    <p>Generate everything at once: itinerary, activities, weather, accommodation, expenses, and more!</p>
                    <button class="btn btn-primary-modern btn-lg" onclick="generateCompleteTrip({{ trip.id }})">
                        ‚ú® Generate Complete Trip Plan
                    </button>
                </div>
            {% endif %}
        </div>

        <div id="journey-progress" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-check-circle"></i> Journey Progress</h2>
            
            <!-- Trip Progress Overview -->
            <div class="progress-overview mb-4 p-3" style="background: linear-gradient(135deg, #8B4513, #A0522D); color: white; border-radius: 10px;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">üìä Trip Progress</h5>
                        <p class="mb-0" id="progressSummary">{{ progress_data.completed_stops }} of {{ progress_data.total_stops }} checkpoints completed ({{ progress_data.progress_percentage }}%)</p>
                    </div>
                    <div class="text-end">
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-light text-dark" id="totalBadge">{{ progress_data.total_stops }} Total Stops</span>
                            <span class="badge bg-success" id="completedBadge">{{ progress_data.completed_stops }} Completed</span>
                            <span class="badge bg-warning" id="remainingBadge">{{ progress_data.remaining_stops }} Remaining</span>
                        </div>
                        <div class="progress" style="height: 8px; background: rgba(255,255,255,0.3);">
                            <div class="progress-bar bg-success" id="mainProgressBar" style="width: {{ progress_data.progress_percentage }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-warning" onclick="switchToSection('chat')">
                    ü§ñ Travel Assistant
                </button>
                <a href="{% url 'planner:download_trip_pdf' trip.id %}" class="btn btn-primary">
                    üìÑ Download PDF
                </a>
                <button class="btn btn-secondary" onclick="switchToSection('itinerary')">
                    ‚Üê Back
                </button>
            </div>

            <!-- Journey Timeline -->
            <div id="journeyTimeline">
                {% if daily_checkpoints_data %}
                    <div class="timeline-container">
                    {% for day_data in daily_checkpoints_data %}
                        <div class="timeline-day-container">
                            <div class="journey-day">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-1">üåç {{ day_data.day_prefix }}</h4>
                                    <span class="badge bg-light text-dark">{{ day_data.completed_count }}/{{ day_data.total_count }} completed</span>
                                </div>
                                <div class="day-progress-bar">
                                    <div class="day-progress-fill" style="width: {{ day_data.progress_percentage|floatformat:0 }}%"></div>
                                </div>
                            </div>
                            {% for checkpoint in day_data.checkpoints %}
                                <div class="timeline-item">
                                    <div class="timeline-dot {% if checkpoint.completed %}completed{% endif %}"></div>
                                    <div class="timeline-content">
                                        <div class="checkpoint-item {% if checkpoint.completed %}completed{% endif %}" id="checkpoint-{{ checkpoint.id }}">
                                            <div class="form-check form-switch d-flex justify-content-between align-items-center mb-3">
                                                <label class="form-check-label fs-5 fw-bold" for="checkpoint-toggle-{{ checkpoint.id }}">
                                                    {{ checkpoint.name }}
                                                </label>
                                                <input class="form-check-input" type="checkbox" id="checkpoint-toggle-{{ checkpoint.id }}"
                                                    {% if checkpoint.completed %}checked{% endif %}
                                                    onchange="toggleCheckpointCompletion({{ checkpoint.id }})">
                                            </div>

                                            <div class="checkpoint-description mb-3">
                                                {{ checkpoint.description|safe }}
                                            </div>

                                            <div class="mb-3">
                                                <label for="feedback-text-{{ checkpoint.id }}" class="form-label">Your Experience/Feedback:</label>
                                                <textarea class="form-control experience-notes" id="feedback-text-{{ checkpoint.id }}" rows="3"
                                                    onblur="submitCheckpointFeedback({{ checkpoint.id }})"
                                                    {% if not checkpoint.completed %}disabled{% endif %}
                                                >{% if checkpoint.feedback_set.first %}{{ checkpoint.feedback_set.first.feedback }}{% endif %}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-map"></i>
                        <h5>No checkpoints available</h5>
                        <p>Generate your complete trip plan first to see your journey checkpoints!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div id="activities" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-calendar-event"></i> Activity Suggestions</h2>
            {% if trip.activity_suggestions %}
                <div class="row g-3">
                    {% for activity in trip.activity_suggestions %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ activity.name }}</h6>
                                <p class="text-muted small mb-3">{{ activity.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if activity.link %}<a href="{{ activity.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if activity.image_url %}<a href="{{ activity.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if activity.video_url %}<a href="{{ activity.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-event"></i>
                    <h5>No activity suggestions yet.</h5>
                    <p>Click the button to get activity recommendations.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('recommend_activities', {{ trip.id }})">Get Activities</button>
                </div>
            {% endif %}
        </div>

        <div id="weather" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cloud-sun"></i> Weather Forecast</h2>
            {% if trip.weather_forecast %}
                <div class="rendered-content">{{ trip.weather_forecast|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-cloud-sun"></i>
                    <h5>No weather forecast available.</h5>
                    <p>Click the button to get the latest weather forecast.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('weather_forecaster', {{ trip.id }})">Get Weather</button>
                </div>
            {% endif %}
        </div>

        <div id="packing" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-bag"></i> Packing List</h2>
            {% if trip.packing_list %}
                <div class="rendered-content">{{ trip.packing_list|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-bag"></i>
                    <h5>No packing list generated yet.</h5>
                    <p>Click the button to get a personalized packing list.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('packing_list_generator', {{ trip.id }})">Get Packing List</button>
                </div>
            {% endif %}
        </div>

        <div id="food" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cup-hot"></i> Food & Culture</h2>
            {% if trip.food_culture_info %}
                {% if trip.food_culture_info.food_options %}
                <h5 class="fw-bold mb-3">üçΩÔ∏è Food Options</h5>
                <div class="row g-3 mb-4">
                    {% for food_item in trip.food_culture_info.food_options %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ food_item.name }}</h6>
                                <p class="text-muted small mb-3">{{ food_item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if food_item.link %}<a href="{{ food_item.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if food_item.image_url %}<a href="{{ food_item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if food_item.video_url %}<a href="{{ food_item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if trip.food_culture_info.cultural_info %}
                <h5 class="fw-bold mb-3">üèõÔ∏è Cultural Information</h5>
                <div class="rendered-content">{{ trip.food_culture_info.cultural_info|safe }}</div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-cup-hot"></i>
                    <h5>No food and culture information yet.</h5>
                    <p>Click the button to get recommendations.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('food_culture_recommender', {{ trip.id }})">Get Info</button>
                </div>
            {% endif %}
        </div>

        <div id="accommodation" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-house"></i> Accommodation</h2>
            {% if trip.accommodation_info %}
                <div class="row g-3">
                    {% for item in trip.accommodation_info %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-0">{{ item.name }}</h6>
                                    {% if item.rating %}<span class="badge bg-warning">‚≠ê {{ item.rating }}</span>{% endif %}
                                </div>
                                <p class="text-muted small mb-3">{{ item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="{{ item.link }}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-house"></i> Book Now</a>
                                    {% if item.image_url %}<a href="{{ item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photos</a>{% endif %}
                                    {% if item.video_url %}<a href="{{ item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Tour</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-house"></i>
                    <h5>No accommodation recommendations yet.</h5>
                    <p>Click the button to get suggestions.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('accommodation_recommender', {{ trip.id }})">Get Stays</button>
                </div>
            {% endif %}
        </div>

        <div id="expenses" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-currency-dollar"></i> Expense Breakdown</h2>
            {% if trip.expense_breakdown %}
                <div class="rendered-content">{{ trip.expense_breakdown|safe }}</div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-currency-dollar"></i>
                    <h5>No expense breakdown available.</h5>
                    <p>Click the button to generate a cost analysis.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('expense_breakdown', {{ trip.id }})">Get Expenses</button>
                </div>
            {% endif %}
        </div>

        

        <div id="links" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-link-45deg"></i> Useful Links</h2>
            {% if trip.useful_links %}
                <div class="row g-3">
                    {% for link in trip.useful_links %}
                    <div class="col-md-6">
                        <a href="{{ link.link }}" target="_blank" class="card-modern text-decoration-none h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold text-primary mb-2">{{ link.title }}</h6>
                                <small class="text-muted">{{ link.link|truncatechars:50 }}</small>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-link-45deg"></i>
                    <h5>No useful links available yet.</h5>
                    <p>Click the button to fetch useful links.</p>
                    <button class="btn btn-primary-modern" onclick="processTrip('fetch_useful_links', {{ trip.id }})">Get Links</button>
                </div>
            {% endif %}
        </div>

        <div id="chat" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-robot"></i> AI Travel Assistant</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    {% for message in trip.chatmessage_set.all %}
                    <div class="chat-message chat-message-user">
                        <div class="chat-bubble chat-bubble-user">{{ message.question }}</div>
                        <img src="https://placehold.co/40x40/3b82f6/FFFFFF/png" alt="User Avatar" class="chat-avatar">
                    </div>
                    <div class="chat-message chat-message-ai">
                        <img src="{% static 'images/logo.png' %}" alt="AI Avatar" class="chat-avatar">
                        <div class="chat-bubble chat-bubble-ai">
                            <div class="rendered-content">{{ message.response|safe }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-chat-dots display-4 mb-3"></i>
                        <p>No messages yet. Start a conversation!</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="chat-input-container">
                    <form id="chatForm" action="{% url 'planner:chat_with_agent' trip.id %}" method="post">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="user_question" class="form-control" placeholder="Ask about your trip..." required>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.timeline-container {
    position: relative;
    padding-left: 30px; /* Space for the timeline line and dots */
}

.timeline-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 10px; /* Position of the main timeline line */
    width: 2px;
    height: 100%;
    background: #e0e0e0; /* Light gray line */
}

.timeline-day-container {
    margin-bottom: 30px;
    position: relative;
}

.timeline-day-container:last-child {
    margin-bottom: 0;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
    padding-left: 20px; /* Space for the dot */
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-dot {
    position: absolute;
    top: 8px; /* Adjust to vertically center with checkpoint-item */
    left: -6px; /* Position relative to the timeline-container's line */
    width: 14px;
    height: 14px;
    background: #8B4513; /* Dot color */
    border-radius: 50%;
    border: 2px solid #fff; /* White border around the dot */
    z-index: 1;
}

.timeline-dot.completed {
    background: #28a745; /* Green for completed dots */
}

.timeline-content {
    /* Styles for the content next to the dot */
}

/* Adjust existing styles for better integration */
.journey-day {
    background: linear-gradient(135deg, #8B4513, #A0522D);
    color: white;
    padding: 1rem 1.5rem;
    margin: 1rem 0 1rem -30px; /* Adjust margin to align with timeline */
    border-radius: 10px;
    position: relative;
    z-index: 1; /* Ensure it's above the timeline line */
    width: calc(100% + 30px); /* Extend to cover the left margin */
}

.checkpoint-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    margin: 0; /* Remove previous margin */
    padding: 1.5rem;
    position: relative;
    transition: all 0.3s ease;
    border-left: 4px solid #8B4513;
}

.checkpoint-item.completed {
    background: #d4edda;
    border-color: #28a745;
    border-left-color: #28a745;
}

.checkpoint-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.checkpoint-time {
    display: inline-flex;
    align-items: center;
    background: #8B4513;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.checkpoint-location {
    font-size: 1.1rem;
    font-weight: 700;
    color: #8B4513;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkpoint-description {
    color: #6c757d;
    margin-bottom: 1rem;
    line-height: 1.6;
}

.checkpoint-tip {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.experience-notes {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    width: 100%;
    min-height: 80px;
    margin-bottom: 1rem;
    resize: vertical;
}

.checkpoint-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.complete-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.complete-btn:hover {
    background: #218838;
    transform: translateY(-1px);
}

.complete-btn.completed {
    background: #6c757d;
    cursor: default;
}

.timeline-connector {
    position: absolute;
    left: 2rem;
    top: 0;
    bottom: -1rem;
    width: 2px;
    background: #8B4513;
    opacity: 0.3;
}

.timeline-connector.last {
    display: none;
}

.journey-started {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const logoUrl = "{% static 'images/logo.png' %}";

function showNotification(message, type) {
    // This is a placeholder. You might have a more sophisticated notification system.
    // For now, let's just use an alert or console log.
    console.log(`Notification (${type}): ${message}`);
    alert(message); // Simple alert for demonstration
}

function toggleCheckpointCompletion(checkpointId) {
    const checkbox = document.getElementById(`checkpoint-toggle-${checkpointId}`);
    const isCompleted = checkbox.checked;
    const checkpointItem = document.getElementById(`checkpoint-${checkpointId}`);
    const feedbackTextarea = document.getElementById(`feedback-text-${checkpointId}`);

    fetch(`/planner/trip/${trip.id}/checkpoint/${checkpointId}/complete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ completed: isCompleted })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (isCompleted) {
                checkpointItem.classList.add('completed');
                feedbackTextarea.disabled = false;
                showNotification('Checkpoint marked as complete!', 'success');
            } else {
                checkpointItem.classList.remove('completed');
                feedbackTextarea.disabled = true;
                showNotification('Checkpoint marked as incomplete.', 'info');
            }
            // Reload page to update progress bars and counts
            location.reload();
        } else {
            showNotification('Error updating checkpoint: ' + data.message, 'error');
            checkbox.checked = !isCompleted; // Revert checkbox state on error
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating checkpoint.', 'error');
        checkbox.checked = !isCompleted; // Revert checkbox state on error
    });
}

function submitCheckpointFeedback(checkpointId) {
    const feedbackTextarea = document.getElementById(`feedback-text-${checkpointId}`);
    const feedback = feedbackTextarea.value;

    fetch(`/planner/trip/${trip.id}/checkpoint/${checkpointId}/feedback/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ feedback: feedback })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Feedback saved successfully!', 'success');
        } else {
            showNotification('Error saving feedback: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while saving feedback.', 'error');
    });
}

function saveProgressToLocalStorage() {
    const progressData = {
        tripId: {{ trip.id }},
        journeyStarted: journeyStarted,
        completedCheckpoints: Array.from(completedCheckpoints),
        checkpointNotes: journeyCheckpoints.reduce((acc, checkpoint) => {
            if (checkpoint.notes) {
                acc[checkpoint.id] = checkpoint.notes;
            }
            return acc;
        }, {}),
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('journeyProgress_{{ trip.id }}', JSON.stringify(progressData));
}

function loadSavedProgress() {
    const savedProgress = localStorage.getItem('journeyProgress_{{ trip.id }}');
    if (savedProgress) {
        try {
            const data = JSON.parse(savedProgress);
            journeyStarted = data.journeyStarted || false;
            completedCheckpoints = new Set(data.completedCheckpoints || []);
            
            const startJourneyBtn = document.getElementById('startJourneyBtn');
            if (journeyStarted && startJourneyBtn) {
                startJourneyBtn.innerHTML = 'üéØ Journey Started';
                startJourneyBtn.classList.add('journey-started');
                startJourneyBtn.disabled = true;
            }
            
            // Apply saved notes to checkpoints - will be applied after checkpoints are loaded
            window.savedCheckpointNotes = data.checkpointNotes || {};
            
            console.log('Loaded progress:', { journeyStarted, completedCount: completedCheckpoints.size });
        } catch (e) {
            console.error('Error loading saved progress:', e);
        }
    }
}

function applySavedNotesToCheckpoints() {
    if (window.savedCheckpointNotes && journeyCheckpoints.length > 0) {
        Object.keys(window.savedCheckpointNotes).forEach(checkpointId => {
            const checkpoint = journeyCheckpoints.find(c => c.id === parseInt(checkpointId));
            if (checkpoint) {
                checkpoint.notes = window.savedCheckpointNotes[checkpointId];
            }
        });
        delete window.savedCheckpointNotes; // Clean up
    }
}

function switchToSection(sectionId) {
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const tabContents = document.querySelectorAll('.tab-content');
    
    sidebarLinks.forEach(l => l.classList.remove('active'));
    tabContents.forEach(t => t.style.display = 'none');
    
    const targetLink = document.querySelector(`[data-target="${sectionId}"]`);
    const targetSection = document.getElementById(sectionId);
    
    if (targetLink) targetLink.classList.add('active');
    if (targetSection) targetSection.style.display = 'block';
}

function generateCompleteTrip(tripId) {
    showLoading('üéØ Generating your complete trip plan...\n\nThis includes:\n‚Ä¢ Detailed itinerary\n‚Ä¢ Activity suggestions\n‚Ä¢ Weather forecast\n‚Ä¢ Packing list\n‚Ä¢ Food & culture info\n‚Ä¢ Accommodation options\n‚Ä¢ Expense breakdown\n‚Ä¢ Comprehensive plan\n\nPlease wait, this may take a few moments...');
    
    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `agent_name=generate_complete_trip&user_question=Generate complete trip plan with all components`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification('üéâ Complete trip plan generated successfully! All sections have been populated.', 'success');
            
            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                data.warnings.forEach(warning => {
                    showNotification(`‚ö†Ô∏è ${warning}`, 'warning');
                });
            }
            
            // Auto-load journey checkpoints if we\\'re on the journey progress section
            const journeySection = document.getElementById('journey-progress');
            if (journeySection && journeySection.style.display !== 'none') {
                setTimeout(() => {
                    loadJourneyCheckpoints();
                }, 1000);
            }
            
            // Reload page to show all generated content
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('An error occurred while generating your complete trip plan.', 'error');
    });
}

function processTrip(agentName, tripId) {
    showLoading(`Generating ${agentName.replace('_', ' ')}...`);
    
    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `agent_name=${agentName}&user_question=Generate ${agentName.replace('_', ' ')}`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification('Information generated successfully!', 'success');
            if (data.warning) {
                showNotification('Warning: ' + data.warning, 'warning');
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('An error occurred while processing your request.', 'error');
    });
}

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const question = formData.get('user_question');
    
    if (!question.trim()) return;
    
    addChatMessage(question, 'user');
    this.querySelector('input[name="user_question"]').value = '';
    addTypingIndicator();
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.status === 'success') {
            addChatMessage(data.chat_response, 'ai');
        } else {
            addChatMessage('Sorry, I encountered an error.', 'ai');
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        addChatMessage('Sorry, I encountered an error.', 'ai');
        showNotification('An error occurred while sending your message.', 'error');
    });
});

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message chat-message-${sender}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${sender}`;
    bubble.innerHTML = message;

    const avatar = document.createElement('img');
    avatar.className = 'chat-avatar';
    if (sender === 'user') {
        avatar.src = 'https://placehold.co/40x40/3b82f6/FFFFFF/png';
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
    } else {
        avatar.src = logoUrl;
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message chat-message-ai';
    typingDiv.id = 'typingIndicator';
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-ai';
    bubble.innerHTML = '<i class="bi bi-three-dots"></i> AI is typing...';
    
    typingDiv.appendChild(bubble);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const sidebarLinks = document.querySelectorAll('.sidebar-link');

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default anchor link behavior
            const targetId = this.getAttribute('data-target');
            switchToSection(targetId);

            // Update URL hash without reloading the page
            history.pushState(null, '', `#${targetId}`);
        });
    });

    // Handle initial load with hash in URL
    if (window.location.hash) {
        const initialSectionId = window.location.hash.substring(1); // Remove '#'
        switchToSection(initialSectionId);
    }
});
</script>
{% endblock %}