{% extends 'base.html' %}
{% load static %}

{% block title %}{{ trip.destination }} - Interactive Trip Planner{% endblock %}

{% block extra_css %}
<style>
.trip-detail-header {
    background: linear-gradient(135deg, #8B4513, #A0522D);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 20px 20px;
}

.progress-widget {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.progress-bar-custom {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.weather-widget {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.destination-item {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    margin: 1rem 0;
    padding: 1.2rem;
    background: white;
    transition: all 0.3s ease;
    position: relative;
}

.destination-item.completed {
    background: #d4edda;
    border-color: #28a745;
}

.destination-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.destination-checkbox {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.feedback-section {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    display: none;
}

.feedback-section.show {
    display: block;
}

.btn-feedback {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.btn-feedback:hover {
    background: #138496;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<!-- Trip Header -->
<section class="trip-detail-header fade-in-up">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold mb-3">üìç {{ trip.destination }}</h1>
                <p class="lead mb-4">{{ trip.month }} ‚Ä¢ {{ trip.duration }} days ‚Ä¢ {{ trip.holiday_type }}</p>
                {% if trip.comments %}
                <p class="mb-0"><i class="bi bi-chat-quote"></i> "{{ trip.comments }}"</p>
                {% endif %}
            </div>
            <div class="col-lg-4 text-lg-end">
                <a href="{% url 'dashboard' %}" class="btn btn-light btn-lg">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                <a href="{% url 'download_trip_pdf' trip.id %}" class="btn btn-success btn-lg ms-2">
                    <i class="bi bi-download"></i> Download PDF
                </a>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <div class="row g-4">
        <!-- Trip Navigation Sidebar -->
        <div class="col-lg-3">
            <!-- Progress Widget -->
            <div class="progress-widget">
                <h6 class="mb-3">üìà Trip Progress</h6>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Destinations Visited</span>
                    <span class="badge bg-primary" id="progressBadge">0/0</span>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-center">
                    <small class="text-muted" id="progressText">Start exploring your destinations!</small>
                </div>
            </div>

            <!-- Weather Widget -->
            <div class="weather-widget">
                <h6 class="mb-3">üå§Ô∏è Current Weather</h6>
                {% if weather_data %}
                <div class="text-center">
                    <div class="display-4 mb-2">‚òÅÔ∏è</div>
                    <h5 class="mb-1">{{ weather_data.temperature }}¬∞C</h5>
                    <p class="text-muted mb-3">{{ weather_data.condition|title }}</p>
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted">Humidity</small>
                            <div><strong>{{ weather_data.humidity }}%</strong></div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Wind</small>
                            <div><strong>{{ weather_data.wind_speed }} m/s</strong></div>
                        </div>
                    </div>
                    <button class="btn btn-light btn-sm mt-3 w-100" onclick="refreshWeather()">üîÑ Refresh</button>
                </div>
                {% else %}
                <p class="text-muted text-center">Weather data unavailable</p>
                {% endif %}
            </div>

            <!-- Original Sidebar Navigation -->
            <div class="sidebar-modern">
                <h3 class="sidebar-title">
                    <i class="bi bi-compass"></i>
                    Trip Menu
                </h3>
                <ul class="list-unstyled">
                    <li><a href="#interactive-progress" class="sidebar-link active" data-target="interactive-progress"><i class="bi bi-check-circle me-2"></i>Interactive Progress</a></li>
                    <li><a href="#activities" class="sidebar-link" data-target="activities"><i class="bi bi-calendar-event me-2"></i>Activities</a></li>
                    <li><a href="#weather" class="sidebar-link" data-target="weather"><i class="bi bi-cloud-sun me-2"></i>Weather</a></li>
                    <li><a href="#packing" class="sidebar-link" data-target="packing"><i class="bi bi-bag me-2"></i>Packing List</a></li>
                    <li><a href="#accommodation" class="sidebar-link" data-target="accommodation"><i class="bi bi-house me-2"></i>Accommodation</a></li>
                    <li><a href="#expenses" class="sidebar-link" data-target="expenses"><i class="bi bi-currency-dollar me-2"></i>Expenses</a></li>
                    <li><a href="#complete-plan" class="sidebar-link" data-target="complete-plan"><i class="bi bi-journal-check me-2"></i>Complete Plan</a></li>
                    <li><a href="#chat" class="sidebar-link" data-target="chat"><i class="bi bi-robot me-2"></i>AI Assistant</a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 fade-in-up-delay-2">
            <!-- Interactive Progress Section -->
            <div id="interactive-progress" class="content-section tab-content active">
                <h2 class="section-title"><i class="bi bi-check-circle"></i> Interactive Trip Progress</h2>
                <div id="destinationsContainer">
                    <!-- Dynamic destinations will be loaded here -->
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-primary-modern" onclick="loadDestinations()">
                        üèõÔ∏è Load Destinations from AI Plan
                    </button>
                </div>
            </div>

            <!-- Activities Section -->
            <div id="activities" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-calendar-event"></i> Activity Suggestions</h2>
                {% if trip.activity_suggestions %}
                    <div class="row g-3">
                        {% for activity in trip.activity_suggestions %}
                        <div class="col-md-6">
                            <div class="card-modern h-100">
                                <div class="card-body-modern">
                                    <h6 class="fw-bold mb-2">{{ activity.name }}</h6>
                                    <p class="text-muted small mb-3">{{ activity.snippet }}</p>
                                    <div class="d-flex gap-2 flex-wrap">
                                        {% if activity.link %}<a href="{{ activity.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                        {% if activity.image_url %}<a href="{{ activity.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-calendar-event"></i>
                        <h5>No activity suggestions yet.</h5>
                        <button class="btn btn-primary-modern" onclick="processTrip('recommend_activities', {{ trip.id }})">Get Activities</button>
                    </div>
                {% endif %}
            </div>

            <!-- Weather Section -->
            <div id="weather" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-cloud-sun"></i> Weather Forecast</h2>
                {% if trip.weather_forecast %}
                    <div class="rendered-content">{{ trip.weather_forecast|safe }}</div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-cloud-sun"></i>
                        <h5>No weather forecast available.</h5>
                        <button class="btn btn-primary-modern" onclick="processTrip('weather_forecaster', {{ trip.id }})">Get Weather</button>
                    </div>
                {% endif %}
            </div>

            <!-- Packing Section -->
            <div id="packing" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-bag"></i> Packing List</h2>
                {% if trip.packing_list %}
                    <div class="rendered-content">{{ trip.packing_list|safe }}</div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-bag"></i>
                        <h5>No packing list generated yet.</h5>
                        <button class="btn btn-primary-modern" onclick="processTrip('packing_list_generator', {{ trip.id }})">Get Packing List</button>
                    </div>
                {% endif %}
            </div>

            <!-- Accommodation Section -->
            <div id="accommodation" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-house"></i> Accommodation</h2>
                {% if trip.accommodation_info %}
                    <div class="row g-3">
                        {% for item in trip.accommodation_info %}
                        <div class="col-md-6">
                            <div class="card-modern h-100">
                                <div class="card-body-modern">
                                    <h6 class="fw-bold mb-2">{{ item.name }}</h6>
                                    <p class="text-muted small mb-3">{{ item.snippet }}</p>
                                    <a href="{{ item.link }}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-house"></i> Book Now</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-house"></i>
                        <h5>No accommodation recommendations yet.</h5>
                        <button class="btn btn-primary-modern" onclick="processTrip('accommodation_recommender', {{ trip.id }})">Get Stays</button>
                    </div>
                {% endif %}
            </div>

            <!-- Expenses Section -->
            <div id="expenses" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-currency-dollar"></i> Expense Breakdown</h2>
                {% if trip.expense_breakdown %}
                    <div class="rendered-content">{{ trip.expense_breakdown|safe }}</div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-currency-dollar"></i>
                        <h5>No expense breakdown available.</h5>
                        <button class="btn btn-primary-modern" onclick="processTrip('expense_breakdown', {{ trip.id }})">Get Expenses</button>
                    </div>
                {% endif %}
            </div>

            <!-- Complete Plan Section -->
            <div id="complete-plan" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-journal-check"></i> Complete Trip Plan</h2>
                {% if trip.complete_trip_plan %}
                    <div class="rendered-content">{{ trip.complete_trip_plan|linebreaks }}</div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-journal-check"></i>
                        <h5>No complete trip plan generated yet.</h5>
                        <button class="btn btn-primary-modern" onclick="processTrip('complete_trip_plan', {{ trip.id }})">Get Complete Plan</button>
                    </div>
                {% endif %}
            </div>

            <!-- AI Assistant Section -->
            <div id="chat" class="content-section tab-content" style="display: none;">
                <h2 class="section-title"><i class="bi bi-robot"></i> AI Travel Assistant</h2>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        {% for message in trip.chatmessage_set.all %}
                        <div class="chat-message chat-message-user">
                            <div class="chat-bubble chat-bubble-user">{{ message.question }}</div>
                            <img src="https://placehold.co/40x40/3b82f6/FFFFFF/png" alt="User Avatar" class="chat-avatar">
                        </div>
                        <div class="chat-message chat-message-ai">
                            <img src="{% static 'images/logo.png' %}" alt="AI Avatar" class="chat-avatar">
                            <div class="chat-bubble chat-bubble-ai">{{ message.response|linebreaks }}</div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-chat-dots display-4 mb-3"></i>
                            <p>No messages yet. Start a conversation!</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="chat-input-container">
                        <form id="chatForm" action="{% url 'chat_with_agent' trip.id %}" method="post">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" name="user_question" class="form-control" placeholder="Ask about your trip..." required>
                                <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const logoUrl = "{% static 'images/logo.png' %}";
let destinations = [];
let completedDestinations = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize sidebar navigation
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const tabContents = document.querySelectorAll('.tab-content');

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            // Deactivate all links and tabs
            sidebarLinks.forEach(l => l.classList.remove('active'));
            tabContents.forEach(t => t.style.display = 'none');
            // Activate the clicked link and tab
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'block';
        });
    });
    
    // Auto-load destinations if complete plan exists
    {% if trip.complete_trip_plan %}
        loadDestinations();
    {% endif %}
});

function loadDestinations() {
    const completeTrip = `{{ trip.complete_trip_plan|escapejs }}`;
    const activities = `{{ trip.activity_suggestions|escapejs }}`;
    
    if (!completeTrip && !activities) {
        showNotification('No trip plan available. Please generate a complete trip plan first.', 'warning');
        return;
    }
    
    // Parse destinations from complete trip plan
    destinations = parseDestinationsFromText(completeTrip);
    
    // Add activity suggestions as destinations
    {% if trip.activity_suggestions %}
        {% for activity in trip.activity_suggestions %}
            destinations.push({
                name: "{{ activity.name|escapejs }}",
                description: "{{ activity.snippet|escapejs }}",
                type: "activity",
                link: "{{ activity.link|default:'' }}"
            });
        {% endfor %}
    {% endif %}
    
    // Add accommodation suggestions as destinations  
    {% if trip.accommodation_info %}
        {% for item in trip.accommodation_info %}
            destinations.push({
                name: "{{ item.name|escapejs }}",
                description: "{{ item.snippet|escapejs }}",
                type: "accommodation",
                link: "{{ item.link|default:'' }}"
            });
        {% endfor %}
    {% endif %}
    
    renderDestinations();
    updateProgressDisplay();
}

function parseDestinationsFromText(text) {
    const destinations = [];
    
    // Extract places mentioned in the itinerary
    const placePatterns = [
        /visit\s+([A-Z][a-zA-Z\s,]+)/gi,
        /explore\s+([A-Z][a-zA-Z\s,]+)/gi,
        /(\d+[\.:]\s*)?([A-Z][a-zA-Z\s,]{5,}?)(?:\s*[-:]\s*)/g,
        /Day\s*\d+[:\s]*([A-Z][a-zA-Z\s,]{5,})/gi
    ];
    
    placePatterns.forEach(pattern => {
        let matches;
        while ((matches = pattern.exec(text)) !== null) {
            const place = matches[1] || matches[2];
            if (place && place.length > 3 && place.length < 100) {
                const cleanPlace = place.trim().replace(/[.,;]$/, '');
                if (!destinations.some(d => d.name.toLowerCase() === cleanPlace.toLowerCase())) {
                    destinations.push({
                        name: cleanPlace,
                        description: 'Destination mentioned in your AI-generated itinerary',
                        type: 'place'
                    });
                }
            }
        }
    });
    
    return destinations.slice(0, 15); // Limit to 15 destinations
}

function renderDestinations() {
    const container = document.getElementById('destinationsContainer');
    
    if (destinations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-geo-alt display-4 mb-3"></i>
                <h5>No destinations found</h5>
                <p>Generate a complete trip plan first to see interactive destinations.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = destinations.map((destination, index) => `
        <div class="destination-item" id="destination-${index}">
            <input type="checkbox" class="destination-checkbox" id="checkbox-${index}" 
                   onchange="toggleDestinationCompletion(${index})">
            
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 pe-3">
                    <h6 class="fw-bold mb-2">
                        ${getDestinationIcon(destination.type)} ${destination.name}
                    </h6>
                    <p class="text-muted mb-2">${destination.description}</p>
                    ${destination.link ? `<a href="${destination.link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> More Info</a>` : ''}
                </div>
            </div>
            
            <div class="feedback-section" id="feedback-${index}">
                <h6 class="mb-2">üìù Your Experience</h6>
                <textarea class="form-control mb-2" placeholder="Share your experience at ${destination.name}..." 
                          rows="2" onchange="saveFeedback(${index}, this.value)"></textarea>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success" onclick="addRating(${index}, 'good')">üëç Loved it</button>
                    <button class="btn btn-sm btn-outline-warning" onclick="addRating(${index}, 'okay')">üëå It was okay</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="addRating(${index}, 'bad')">üëé Didn't like</button>
                </div>
            </div>
        </div>
    `).join('');
}

function getDestinationIcon(type) {
    switch(type) {
        case 'activity': return 'üéØ';
        case 'accommodation': return 'üè®';
        case 'place': return 'üìç';
        default: return 'üó∫Ô∏è';
    }
}

function toggleDestinationCompletion(index) {
    const destinationElement = document.getElementById(`destination-${index}`);
    const checkbox = document.getElementById(`checkbox-${index}`);
    const feedbackSection = document.getElementById(`feedback-${index}`);
    
    if (checkbox.checked) {
        destinationElement.classList.add('completed');
        feedbackSection.classList.add('show');
        if (!completedDestinations.includes(index)) {
            completedDestinations.push(index);
        }
        showNotification(`‚úÖ Marked "${destinations[index].name}" as visited!`, 'success');
    } else {
        destinationElement.classList.remove('completed');
        feedbackSection.classList.remove('show');
        completedDestinations = completedDestinations.filter(i => i !== index);
        showNotification(`Unmarked "${destinations[index].name}"`, 'info');
    }
    
    updateProgressDisplay();
    saveProgressToLocalStorage();
}

function updateProgressDisplay() {
    const total = destinations.length;
    const completed = completedDestinations.length;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    document.getElementById('progressBadge').textContent = `${completed}/${total}`;
    document.getElementById('progressBar').style.width = `${percentage}%`;
    
    let progressText = '';
    if (completed === 0) {
        progressText = 'Start exploring your destinations!';
    } else if (completed === total) {
        progressText = 'üéâ Trip completed! Great job!';
    } else {
        progressText = `${total - completed} destinations remaining`;
    }
    
    document.getElementById('progressText').textContent = progressText;
}

function saveFeedback(index, feedback) {
    // Save feedback to localStorage for now
    const feedbackData = JSON.parse(localStorage.getItem('tripFeedback') || '{}');
    feedbackData[`{{ trip.id }}_${index}`] = {
        feedback: feedback,
        destination: destinations[index].name,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('tripFeedback', JSON.stringify(feedbackData));
    
    if (feedback.trim()) {
        showNotification(`üí¨ Feedback saved for ${destinations[index].name}`, 'success');
    }
}

function addRating(index, rating) {
    const feedbackData = JSON.parse(localStorage.getItem('tripFeedback') || '{}');
    const key = `{{ trip.id }}_${index}`;
    
    if (!feedbackData[key]) {
        feedbackData[key] = {
            feedback: '',
            destination: destinations[index].name,
            timestamp: new Date().toISOString()
        };
    }
    
    feedbackData[key].rating = rating;
    localStorage.setItem('tripFeedback', JSON.stringify(feedbackData));
    
    const ratingText = rating === 'good' ? 'üëç Loved it' : rating === 'okay' ? 'üëå It was okay' : 'üëé Didn\'t like';
    showNotification(`${ratingText} - Rating saved for ${destinations[index].name}`, 'success');
}

function saveProgressToLocalStorage() {
    const progressData = {
        tripId: {{ trip.id }},
        completedDestinations: completedDestinations,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('tripProgress', JSON.stringify(progressData));
}

function refreshWeather() {
    showNotification('üîÑ Refreshing weather data...', 'info');
    // In a real implementation, this would fetch fresh weather data
    setTimeout(() => {
        showNotification('üå§Ô∏è Weather data refreshed!', 'success');
    }, 1000);
}

function processTrip(agentName, tripId) {
    showLoading(`Generating ${agentName.replace('_', ' ')}...`);
    
    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `agent_name=${agentName}&user_question=Generate ${agentName.replace('_', ' ')}`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showNotification('Information generated successfully!', 'success');
            if (data.warning) {
                showNotification('Warning: ' + data.warning, 'warning');
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('An error occurred while processing your request.', 'error');
    });
}

// Chat functionality
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const question = formData.get('user_question');
    
    if (!question.trim()) return;
    
    addChatMessage(question, 'user');
    this.querySelector('input[name="user_question"]').value = '';
    addTypingIndicator();
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.status === 'success') {
            addChatMessage(data.chat_response, 'ai');
        } else {
            addChatMessage('Sorry, I encountered an error.', 'ai');
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        addChatMessage('Sorry, I encountered an error.', 'ai');
        showNotification('An error occurred while sending your message.', 'error');
    });
});

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message chat-message-${sender}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${sender}`;
    bubble.innerHTML = message;

    const avatar = document.createElement('img');
    avatar.className = 'chat-avatar';
    if (sender === 'user') {
        avatar.src = 'https://placehold.co/40x40/3b82f6/FFFFFF/png';
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
    } else {
        avatar.src = logoUrl;
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message chat-message-ai';
    typingDiv.id = 'typingIndicator';
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-ai';
    bubble.innerHTML = '<i class="bi bi-three-dots"></i> AI is typing...';
    
    typingDiv.appendChild(bubble);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}
</script>
{% endblock %}