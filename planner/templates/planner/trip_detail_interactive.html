{% extends 'base.html' %}
{% load static %}
{% load form_extras %}

{% block title %}Trip Details - {{ trip.destination }} - SAFAR_SMART{% endblock %}

{% block content %}
<!-- Trip Header -->
<section class="trip-detail-header fade-in-up">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3">{{ trip.destination }}</h1>
            <p class="lead mb-4">{{ trip.month }} ‚Ä¢ {{ trip.duration }} days ‚Ä¢ {{ trip.holiday_type }}</p>
            {% if trip.comments %}
            <p class="mb-0"><i class="bi bi-chat-quote"></i> "{{ trip.comments }}"</p>
            {% endif %}
        </div>
        <div class="col-lg-4 text-lg-end">
            <a href="{% url 'planner:dashboard' %}" class="btn btn-light btn-lg">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</section>

<div class="row g-4">
    <!-- Trip Navigation Sidebar -->
    <div class="col-lg-3">
        <div class="sidebar-modern">
            <h3 class="sidebar-title">
                <i class="bi bi-compass"></i>
                Trip Menu
            </h3>
            <ul class="list-unstyled">
                <li><a href="#itinerary" class="sidebar-link active" data-target="itinerary"><i class="bi bi-map me-2"></i>Itinerary</a></li>
                <li><a href="#journey-progress" class="sidebar-link" data-target="journey-progress"><i class="bi bi-check-circle me-2"></i>Journey Progress</a></li>
                <li><a href="#activities" class="sidebar-link" data-target="activities"><i class="bi bi-calendar-event me-2"></i>Activities</a></li>
                <li><a href="#weather" class="sidebar-link" data-target="weather"><i class="bi bi-cloud-sun me-2"></i>Weather</a></li>
                <li><a href="#packing" class="sidebar-link" data-target="packing"><i class="bi bi-bag me-2"></i>Packing List</a></li>
                <li><a href="#food" class="sidebar-link" data-target="food"><i class="bi bi-cup-hot me-2"></i>Food & Culture</a></li>
                <li><a href="#accommodation" class="sidebar-link" data-target="accommodation"><i class="bi bi-house me-2"></i>Accommodation</a></li>
                <li><a href="#expenses" class="sidebar-link" data-target="expenses"><i class="bi bi-currency-dollar me-2"></i>Expenses</a></li>
                
                <li><a href="#links" class="sidebar-link" data-target="links"><i class="bi bi-link-45deg me-2"></i>Useful Links</a></li>
                <li><a href="#chat" class="sidebar-link" data-target="chat"><i class="bi bi-robot me-2"></i>AI Assistant</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 fade-in-up-delay-2">
        <div id="itinerary" class="content-section tab-content active">
            <h2 class="section-title"><i class="bi bi-map"></i> Your Complete Itinerary</h2>
            {% if trip.itinerary %}
                <div class="rendered-content">{{ trip.itinerary|safe }}</div>
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating content...</p>
                </div>
            {% endif %}
        </div>

        <div id="journey-progress" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-check-circle"></i> Journey Progress</h2>
            
            <!-- Trip Progress Overview -->
            <div class="progress-overview mb-4 p-3" style="background: linear-gradient(135deg, #8B4513, #A0522D); color: white; border-radius: 10px;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">üìä Trip Progress</h5>
                        <p class="mb-0" id="progressSummary">{{ progress_data.completed_stops }} of {{ progress_data.total_stops }} checkpoints completed ({{ progress_data.progress_percentage }}%)</p>
                    </div>
                    <div class="text-end">
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-light text-dark" id="totalBadge">{{ progress_data.total_stops }} Total Stops</span>
                            <span class="badge bg-success" id="completedBadge">{{ progress_data.completed_stops }} Completed</span>
                            <span class="badge bg-warning" id="remainingBadge">{{ progress_data.remaining_stops }} Remaining</span>
                        </div>
                        <div class="progress" style="height: 8px; background: rgba(255,255,255,0.3);">
                            <div class="progress-bar bg-success" id="mainProgressBar" style="width: {{ progress_data.progress_percentage }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                {% if not trip.is_started %}
                <button class="btn btn-success btn-lg" onclick="startJourney({{ trip.id }})">
                    <i class="bi bi-play-circle"></i> Start Journey
                </button>
                {% else %}
                <button class="btn btn-secondary btn-lg" disabled>
                    <i class="bi bi-check-circle"></i> Journey Started
                </button>
                {% endif %}
                <button class="btn btn-warning" onclick="switchToSection('chat')">
                    ü§ñ Travel Assistant
                </button>
                <a href="{% url 'planner:download_trip_pdf' trip.id %}" class="btn btn-primary">
                    üìÑ Download PDF
                </a>
                <button class="btn btn-info" onclick="regenerateTripPlan()">
                    üîÑ Regenerate Plan
                </button>
                <button class="btn btn-secondary" onclick="switchToSection('itinerary')">
                    ‚Üê Back
                </button>
            </div>

            <!-- Journey Timeline -->
            <div id="journeyTimeline">
                {% if daily_checkpoints_data %}
                    <div class="timeline-container">
                    {% for day_prefix, day_data in daily_checkpoints_data.items %}
                        <div class="timeline-day-container">
                            <div class="journey-day">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-1">üåç {{ day_prefix }}</h4>
                                    <span class="badge bg-light text-dark">{{ day_data.completed_count }}/{{ day_data.total_count }} completed</span>
                                </div>
                                <div class="day-progress-bar">
                                    <div class="day-progress-fill" style="width: {{ day_data.progress_percentage|floatformat:0 }}%"></div>
                                </div>
                            </div>
                            {% for checkpoint in day_data.checkpoints %}
                                <div class="timeline-item">
                                    <div class="timeline-dot {% if checkpoint.completed %}completed{% endif %}"></div>
                                    <div class="timeline-content">
                                        <div class="checkpoint-item {% if checkpoint.completed %}completed{% endif %}" id="checkpoint-{{ checkpoint.id }}">
                                            
                                            <!-- Time Display -->
                                            {% if checkpoint.time %}
                                            <div class="checkpoint-time">
                                                <i class="bi bi-clock"></i> {{ checkpoint.time|date:"H:i" }}
                                            </div>
                                            {% endif %}

                                            <!-- Location Display -->
                                            <div class="checkpoint-location">
                                                {% if checkpoint.location %}
                                                    <i class="bi bi-geo-alt"></i> {{ checkpoint.location }}
                                                {% else %}
                                                    {{ checkpoint.name }}
                                                {% endif %}
                                            </div>

                                            <!-- Activity Description -->
                                            <div class="checkpoint-description mb-3">
                                                {{ checkpoint.description|safe }}
                                            </div>

                                            <!-- Tips Section -->
                                            {% if checkpoint.tips %}
                                            <div class="checkpoint-tip">
                                                <i class="bi bi-lightbulb"></i> {{ checkpoint.tips }}
                                            </div>
                                            {% endif %}

                                            <!-- Weather Information (shown only when journey is started) -->
                                            {% if trip.is_started %}
                                                {% with weather_info=checkpoint_weather_data|lookup:checkpoint.id %}
                                                    {% if weather_info %}
                                                    <div class="weather-card mt-3 p-3 border rounded" style="background: linear-gradient(135deg, #74b9ff, #0984e3); color: white;">
                                                        <div class="d-flex align-items-center">
                                                            {% if weather_info.icon %}
                                                            <img src="https://openweathermap.org/img/wn/{{ weather_info.icon }}@2x.png" 
                                                                 alt="Weather icon" class="weather-icon me-3" style="width: 50px; height: 50px;">
                                                            {% endif %}
                                                            <div>
                                                                <h6 class="mb-1">üå§Ô∏è Current Weather - {{ checkpoint.location|default:"Unknown" }}</h6>
                                                                <p class="mb-1"><strong>{{ weather_info.temperature }}¬∞C</strong> - {{ weather_info.condition|title }}</p>
                                                                <small>üíß {{ weather_info.humidity }}% humidity ‚Ä¢ üí® {{ weather_info.wind_speed }} m/s wind</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}

                                            <!-- Interactive Checkpoint Controls -->
                                            <div class="checkpoint-actions">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="checkpoint-toggle-{{ checkpoint.id }}" 
                                                        {% if checkpoint.completed %}checked{% endif %} 
                                                        onchange="toggleCheckpointCompletion({{ checkpoint.id }})">
                                                    <label class="form-check-label" for="checkpoint-toggle-{{ checkpoint.id }}">Mark as Visited</label>
                                                </div>
                                                <div class="feedback-actions">
                                                    <button class="btn btn-sm btn-outline-success feedback-btn" onclick="submitCheckpointFeedback({{ checkpoint.id }}, 1)">üëç</button>
                                                    <button class="btn btn-sm btn-outline-danger feedback-btn" onclick="submitCheckpointFeedback({{ checkpoint.id }}, 2)">üëé</button>
                                                </div>
                                            </div>

                                            <!-- Experience Notes -->
                                            <div class="mt-3">
                                                <textarea class="form-control experience-notes" id="feedback-text-{{ checkpoint.id }}" rows="2"
                                                    placeholder="Add a note about your experience..."
                                                >{% if checkpoint.feedback_set.first %}{{ checkpoint.feedback_set.first.feedback }}{% endif %}</textarea>
                                                <button class="btn btn-sm btn-primary mt-2" onclick="submitCheckpointFeedback({{ checkpoint.id }})">Save Notes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-map"></i>
                        <h5>No checkpoints available</h5>
                        <p>Generate your complete trip plan first to see your journey checkpoints!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div id="activities" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-calendar-event"></i> Activity Suggestions</h2>
            <div id="activities-content">
                {% if trip.activity_suggestions %}
                    <div class="row g-3">
                        {% for activity in trip.activity_suggestions %}
                        <div class="col-md-6">
                            <div class="card-modern h-100">
                                <div class="card-body-modern">
                                    <h6 class="fw-bold mb-2">{{ activity.name }}</h6>
                                    <p class="text-muted small mb-3">{{ activity.snippet }}</p>
                                    <div class="d-flex gap-2 flex-wrap">
                                        {% if activity.link %}<a href="{{ activity.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                        {% if activity.image_url %}<a href="{{ activity.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                        {% if activity.video_url %}<a href="{{ activity.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="loading-state">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Generating activity suggestions...</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div id="weather" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cloud-sun"></i> Weather Forecast</h2>
            <div id="realtime-weather-display" class="card-modern mb-4" style="display: none;">
                <div class="card-body-modern">
                    <h5 class="card-title"><i class="bi bi-geo-alt"></i> Real-time Weather <span id="realtime-weather-location"></span></h5>
                    <p class="card-text mb-1">Temperature: <span id="realtime-weather-temp"></span>¬∞C</p>
                    <p class="card-text mb-1">Condition: <span id="realtime-weather-condition"></span></p>
                    <p class="card-text mb-1">Humidity: <span id="realtime-weather-humidity"></span>%</p>
                    <p class="card-text">Wind Speed: <span id="realtime-weather-wind"></span> m/s</p>
                    <small class="text-muted">Updated: <span id="realtime-weather-time"></span></small>
                </div>
            </div>
            <div id="weather-content">
            {% if trip.weather_forecast %}
                <div class="rendered-content">{{ trip.weather_forecast|safe }}</div>
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating weather forecast...</p>
                </div>
            {% endif %}
            </div>
        </div>

        <div id="packing" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-bag"></i> Packing List</h2>
            <div id="packing-content">
            {% if trip.packing_list %}
                <div class="rendered-content">{{ trip.packing_list|safe }}</div>
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating packing list...</p>
                </div>
            {% endif %}
            </div>
        </div>

        <div id="food" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-cup-hot"></i> Food & Culture</h2>
            <div id="food-content">
            {% if trip.food_culture_info %}
                {% if trip.food_culture_info.food_options %}
                <h5 class="fw-bold mb-3">üçΩÔ∏è Food Options</h5>
                <div class="row g-3 mb-4">
                    {% for food_item in trip.food_culture_info.food_options %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold mb-2">{{ food_item.name }}</h6>
                                <p class="text-muted small mb-3">{{ food_item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% if food_item.link %}<a href="{{ food_item.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>{% endif %}
                                    {% if food_item.image_url %}<a href="{{ food_item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>{% endif %}
                                    {% if food_item.video_url %}<a href="{{ food_item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if trip.food_culture_info.cultural_info %}
                <h5 class="fw-bold mb-3">üèõÔ∏è Cultural Information</h5>
                <div class="rendered-content">{{ trip.food_culture_info.cultural_info|safe }}</div>
                {% endif %}
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating food and culture info...</p>
                </div>
            {% endif %}
            </div>
        </div>

        <div id="accommodation" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-house"></i> Accommodation</h2>
            <div id="accommodation-content">
            {% if trip.accommodation_info %}
                <div class="row g-3">
                    {% for item in trip.accommodation_info %}
                    <div class="col-md-6">
                        <div class="card-modern h-100">
                            <div class="card-body-modern">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-0">{{ item.name }}</h6>
                                    {% if item.rating %}<span class="badge bg-warning">‚≠ê {{ item.rating }}</span>{% endif %}
                                </div>
                                <p class="text-muted small mb-3">{{ item.snippet }}</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="{{ item.link }}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-house"></i> Book Now</a>
                                    {% if item.image_url %}<a href="{{ item.image_url }}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photos</a>{% endif %}
                                    {% if item.video_url %}<a href="{{ item.video_url }}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Tour</a>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating accommodation suggestions...</p>
                </div>
            {% endif %}
            </div>
        </div>

        <div id="expenses" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-currency-dollar"></i> Expense Breakdown</h2>
            <div id="expenses-content">
            {% if trip.expense_breakdown %}
                <div class="rendered-content">{{ trip.expense_breakdown|safe }}</div>
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating expense breakdown...</p>
                </div>
            {% endif %}
            </div>
        </div>

        

        <div id="links" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-link-45deg"></i> Useful Links</h2>
            <div id="links-content">
            {% if trip.useful_links %}
                <div class="row g-3">
                    {% for link in trip.useful_links %}
                    <div class="col-md-6">
                        <a href="{{ link.link }}" target="_blank" class="card-modern text-decoration-none h-100">
                            <div class="card-body-modern">
                                <h6 class="fw-bold text-primary mb-2">{{ link.title }}</h6>
                                <small class="text-muted">{{ link.link|truncatechars:50 }}</small>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating useful links...</p>
                </div>
            {% endif %}
            </div>
        </div>

        <div id="chat" class="content-section tab-content" style="display: none;">
            <h2 class="section-title"><i class="bi bi-robot"></i> AI Travel Assistant</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    {% for message in trip.chatmessage_set.all %}
                    <div class="chat-message chat-message-user">
                        <div class="chat-bubble chat-bubble-user">{{ message.question }}</div>
                        <img src="https://placehold.co/40x40/3b82f6/FFFFFF/png" alt="User Avatar" class="chat-avatar">
                    </div>
                    <div class="chat-message chat-message-ai">
                        <img src="{% static 'images/logo.png' %}" alt="AI Avatar" class="chat-avatar">
                        <div class="chat-bubble chat-bubble-ai">
                            <div class="rendered-content">{{ message.response|safe }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-chat-dots display-4 mb-3"></i>
                        <p>No messages yet. Start a conversation!</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="chat-input-container">
                    <form id="chatForm" action="{% url 'planner:chat_with_agent' trip.id %}" method="post">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="user_question" class="form-control" placeholder="Ask about your trip..." required>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.timeline-container {
    position: relative;
    padding-left: 30px; /* Space for the timeline line and dots */
}

.timeline-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 10px; /* Position of the main timeline line */
    width: 2px;
    height: 100%;
    background: #e0e0e0; /* Light gray line */
}

.timeline-day-container {
    margin-bottom: 30px;
    position: relative;
}

.timeline-day-container:last-child {
    margin-bottom: 0;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
    padding-left: 20px; /* Space for the dot */
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-dot {
    position: absolute;
    top: 8px; /* Adjust to vertically center with checkpoint-item */
    left: -6px; /* Position relative to the timeline-container's line */
    width: 14px;
    height: 14px;
    background: #8B4513; /* Dot color */
    border-radius: 50%;
    border: 2px solid #fff; /* White border around the dot */
    z-index: 1;
}

.timeline-dot.completed {
    background: #28a745; /* Green for completed dots */
}

.timeline-content {
    /* Styles for the content next to the dot */
}

/* Adjust existing styles for better integration */
.journey-day {
    background: linear-gradient(135deg, #8B4513, #A0522D);
    color: white;
    padding: 1rem 1.5rem;
    margin: 1rem 0 1rem -30px; /* Adjust margin to align with timeline */
    border-radius: 10px;
    position: relative;
    z-index: 1; /* Ensure it's above the timeline line */
    width: calc(100% + 30px); /* Extend to cover the left margin */
}

.checkpoint-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    margin: 0; /* Remove previous margin */
    padding: 1.5rem;
    position: relative;
    transition: all 0.3s ease;
    border-left: 4px solid #8B4513;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.checkpoint-item.completed {
    background: #f0fff4;
    border-color: #28a745;
    border-left-color: #28a745;
}

.checkpoint-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.checkpoint-time {
    display: inline-flex;
    align-items: center;
    background: #8B4513;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.checkpoint-location {
    font-size: 1.1rem;
    font-weight: 700;
    color: #8B4513;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkpoint-description {
    color: #6c757d;
    margin-bottom: 1rem;
    line-height: 1.6;
}

.checkpoint-tip {
    display: flex;
    align-items: flex-start;
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    border-left: 4px solid #17a2b8;
}

.checkpoint-tip i {
    margin-right: 0.5rem;
    margin-top: 0.1rem;
    color: #17a2b8;
    flex-shrink: 0;
}

.experience-notes {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    width: 100%;
    min-height: 80px;
    margin-bottom: 1rem;
    resize: vertical;
}

.checkpoint-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.complete-btn {
    background: #8B4513;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.complete-btn:hover {
    background: #A0522D;
    transform: translateY(-1px);
}

.complete-btn.completed {
    background: #28a745;
    cursor: default;
}

.timeline-connector {
    position: absolute;
    left: 2rem;
    top: 0;
    bottom: -1rem;
    width: 2px;
    background: #8B4513;
    opacity: 0.3;
}

.timeline-connector.last {
    display: none;
}

.journey-started {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const tripId = {{ trip.id }};
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const logoUrl = "{% static 'images/logo.png' %}";

function showNotification(message, type) {
    console.log(`Notification (${type}): ${message}`);
    // Replace with a more sophisticated notification library if you have one
    alert(message);
}

function renderActivities(data) {
    let html = '<div class="row g-3">';
    data.forEach(activity => {
        html += `
            <div class="col-md-6">
                <div class="card-modern h-100">
                    <div class="card-body-modern">
                        <h6 class="fw-bold mb-2">${activity.name}</h6>
                        <p class="text-muted small mb-3">${activity.snippet}</p>
                        <div class="d-flex gap-2 flex-wrap">
                            ${activity.link ? `<a href="${activity.link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>` : ''}
                            ${activity.image_url ? `<a href="${activity.image_url}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>` : ''}
                            ${activity.video_url ? `<a href="${activity.video_url}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function renderFoodAndCulture(data) {
    let html = '';
    if (data.food_options) {
        html += '<h5 class="fw-bold mb-3">üçΩÔ∏è Food Options</h5><div class="row g-3 mb-4">';
        data.food_options.forEach(food_item => {
            html += `
                <div class="col-md-6">
                    <div class="card-modern h-100">
                        <div class="card-body-modern">
                            <h6 class="fw-bold mb-2">${food_item.name}</h6>
                            <p class="text-muted small mb-3">${food_item.snippet}</p>
                            <div class="d-flex gap-2 flex-wrap">
                                ${food_item.link ? `<a href="${food_item.link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link"></i> Visit</a>` : ''}
                                ${food_item.image_url ? `<a href="${food_item.image_url}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photo</a>` : ''}
                                ${food_item.video_url ? `<a href="${food_item.video_url}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Video</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    if (data.cultural_info) {
        html += `<h5 class="fw-bold mb-3">üèõÔ∏è Cultural Information</h5><div class="rendered-content">${data.cultural_info}</div>`;
    }
    return html;
}

function renderAccommodation(data) {
    let html = '<div class="row g-3">';
    data.forEach(item => {
        html += `
            <div class="col-md-6">
                <div class="card-modern h-100">
                    <div class="card-body-modern">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold mb-0">${item.name}</h6>
                            ${item.rating ? `<span class="badge bg-warning">‚≠ê ${item.rating}</span>` : ''}
                        </div>
                        <p class="text-muted small mb-3">${item.snippet}</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="${item.link}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-house"></i> Book Now</a>
                            ${item.image_url ? `<a href="${item.image_url}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-image"></i> Photos</a>` : ''}
                            ${item.video_url ? `<a href="${item.video_url}" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-play"></i> Tour</a>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function renderUsefulLinks(data) {
    let html = '<div class="row g-3">';
    data.forEach(link => {
        html += `
            <div class="col-md-6">
                <a href="${link.link}" target="_blank" class="card-modern text-decoration-none h-100">
                    <div class="card-body-modern">
                        <h6 class="fw-bold text-primary mb-2">${link.title}</h6>
                        <small class="text-muted">${link.link.substring(0, 50)}...</small>
                    </div>
                </a>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

async function generateSectionContent(sectionId, agentName, contentKey) {
    const contentDiv = document.getElementById(`${sectionId}-content`);
    if (!contentDiv || contentDiv.querySelector('.loading-state') === null) {
        // Content is already loaded or there's no loading state
        return;
    }

    try {
        const response = await fetch(`/planner/process_trip/${tripId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `agent_name=${agentName}&user_question=Generate ${agentName.replace(/_/g, ' ')}`
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.status === 'success' && data[contentKey]) {
            let renderedHtml;
            switch (contentKey) {
                case 'activity_suggestions':
                    renderedHtml = renderActivities(data[contentKey]);
                    break;
                case 'food_culture_info':
                    renderedHtml = renderFoodAndCulture(data[contentKey]);
                    break;
                case 'accommodation_info':
                    renderedHtml = renderAccommodation(data[contentKey]);
                    break;
                case 'useful_links':
                    renderedHtml = renderUsefulLinks(data[contentKey]);
                    break;
                default:
                    renderedHtml = `<div class="rendered-content">${data[contentKey]}</div>`;
            }
            contentDiv.innerHTML = renderedHtml;
        } else {
            contentDiv.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><h5>Failed to load content.</h5><p>${data.message || 'An unknown error occurred.'}</p></div>`;
        }
    } catch (error) {
        console.error('Error fetching section content:', error);
        contentDiv.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><h5>An error occurred.</h5><p>Could not load this section. Please try again later.</p></div>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Automatically generate content for empty sections
    generateSectionContent('itinerary', 'generate_itinerary', 'itinerary');
    generateSectionContent('activities', 'recommend_activities', 'activity_suggestions');
    generateSectionContent('weather', 'weather_forecaster', 'weather_forecast');
    generateSectionContent('packing', 'packing_list_generator', 'packing_list');
    generateSectionContent('food', 'food_culture_recommender', 'food_culture_info');
    generateSectionContent('accommodation', 'accommodation_recommender', 'accommodation_info');
    generateSectionContent('expenses', 'expense_breakdown', 'expense_breakdown');
    generateSectionContent('links', 'fetch_useful_links', 'useful_links');

    // Sidebar navigation
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const targetId = this.getAttribute('data-target');
            switchToSection(targetId);
            history.pushState(null, '', `#${targetId}`);
        });
    });

    // Handle initial load with hash in URL
    if (window.location.hash) {
        const initialSectionId = window.location.hash.substring(1);
        switchToSection(initialSectionId);
    }

    // Chat form submission
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const question = formData.get('user_question');
        if (!question.trim()) return;

        addChatMessage(question, 'user');
        this.querySelector('input[name="user_question"]').value = '';
        addTypingIndicator();

        fetch(this.action, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            removeTypingIndicator();
            if (data.status === 'success') {
                addChatMessage(data.chat_response, 'ai');
            } else {
                addChatMessage('Sorry, I encountered an error.', 'ai');
                showNotification('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            removeTypingIndicator();
            addChatMessage('Sorry, I encountered an error.', 'ai');
            showNotification('An error occurred while sending your message.', 'error');
        });
    });
});

function switchToSection(sectionId) {
    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.content-section').forEach(t => t.style.display = 'none');
    const targetLink = document.querySelector(`[data-target="${sectionId}"]`);
    const targetSection = document.getElementById(sectionId);
    if (targetLink) targetLink.classList.add('active');
    if (targetSection) targetSection.style.display = 'block';
}

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message chat-message-${sender}`;
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${sender}`;
    bubble.innerHTML = message;
    const avatar = document.createElement('img');
    avatar.className = 'chat-avatar';
    if (sender === 'user') {
        avatar.src = 'https://placehold.co/40x40/3b82f6/FFFFFF/png';
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(avatar);
    } else {
        avatar.src = logoUrl;
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
    }
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message chat-message-ai';
    typingDiv.id = 'typingIndicator';
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-ai';
    bubble.innerHTML = '<i class="bi bi-three-dots"></i> AI is typing...';
    typingDiv.appendChild(bubble);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function startJourney(tripId) {
    if (!confirm('Are you sure you want to start this journey?')) {
        return;
    }

    fetch(`/planner/trip/${tripId}/start_journey/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Journey started successfully!', 'success');
            location.reload();
        } else {
            showNotification('Error starting journey: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error starting journey:', error);
        showNotification('An error occurred while starting the journey.', 'error');
    });
}

// Real-time weather functionality
function getRealtimeWeather() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            fetch('/planner/get_realtime_weather/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `latitude=${latitude}&longitude=${longitude}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const weather = data.weather;
                    document.getElementById('realtime-weather-location').innerText = weather.location_name;
                    document.getElementById('realtime-weather-temp').innerText = weather.temperature;
                    document.getElementById('realtime-weather-condition').innerText = weather.condition;
                    document.getElementById('realtime-weather-humidity').innerText = weather.humidity;
                    document.getElementById('realtime-weather-wind').innerText = weather.wind_speed;
                    document.getElementById('realtime-weather-time').innerText = new Date().toLocaleTimeString();
                    document.getElementById('realtime-weather-display').style.display = 'block';
                } else {
                    console.error('Error fetching real-time weather:', data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching real-time weather:', error);
            });
        }, error => {
            console.warn('Geolocation error:', error.message);
            // Optionally, show a message to the user that location could not be retrieved
        });
    } else {
        console.warn('Geolocation is not supported by this browser.');
    }
}

// Call getRealtimeWeather if the journey has started
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    if ({{ trip.is_started|lower }}) { // trip.is_started is a boolean, convert to JS boolean
        getRealtimeWeather();
        // Optionally, refresh weather every few minutes
        setInterval(getRealtimeWeather, 5 * 60 * 1000); // Every 5 minutes
    }
});

function regenerateTripPlan() {
    if (!confirm('Are you sure you want to regenerate the entire trip plan? This will replace the existing plan.')) {
        return;
    }

    showNotification('Regenerating your trip plan... This may take a moment.', 'info');

    fetch(`/planner/process_trip/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: 'agent_name=generate_complete_trip'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (data.warning) {
                showNotification('Trip plan regenerated with warnings: ' + data.warning, 'warning');
            } else {
                showNotification('Trip plan regenerated successfully!', 'success');
            }
            location.reload();
        } else {
            showNotification('Error regenerating trip plan: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while regenerating the trip plan.', 'error');
    });
}

function toggleCheckpointCompletion(checkpointId) {
    const checkbox = document.getElementById(`checkpoint-toggle-${checkpointId}`);
    const isCompleted = checkbox.checked;

    fetch(`/planner/trip/${tripId}/checkpoint/${checkpointId}/complete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ completed: isCompleted })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Checkpoint marked as ${isCompleted ? 'complete' : 'incomplete'}.`, 'success');
            location.reload(); // Reload to update progress bars
        } else {
            showNotification('Error updating checkpoint: ' + data.message, 'error');
            checkbox.checked = !isCompleted; // Revert checkbox on error
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the checkpoint.', 'error');
        checkbox.checked = !isCompleted; // Revert checkbox on error
    });
}

function submitCheckpointFeedback(checkpointId, rating = null) {
    const feedbackTextarea = document.getElementById(`feedback-text-${checkpointId}`);
    const feedback = feedbackTextarea.value;

    let payload = { feedback: feedback };
    if (rating) {
        payload.rating = rating;
    }

    fetch(`/planner/trip/${tripId}/checkpoint/${checkpointId}/feedback/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Feedback saved successfully!', 'success');
        } else {
            showNotification('Error saving feedback: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while saving feedback.', 'error');
    });
}

</script>
{% endblock %}